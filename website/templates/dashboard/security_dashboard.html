{% extends "base.html" %}
{% load static %}
{% block content %}
    <link rel="stylesheet" href="{% static 'css/security_dashboard.css' %}">
    <div class="container-fluid dashboard">
        <!-- HEADER -->
        <div class="row mb-3">
            <div class="col">
                <h4 class="fw-bold mb-0">Security Operations Dashboard</h4>
                <small class="text-muted">Last 30 days · Read-only · Internal</small>
            </div>
        </div>
        <div class="row">
            <!-- LEFT KPI COLUMN -->
            <div class="col-xl-2 col-lg-3 col-md-4">
                <div class="kpi-card">
                    <span>Total Issues</span>
                    <h3>{{ total }}</h3>
                </div>
                <div class="kpi-card warning">
                    <span>Open Issues</span>
                    <h3>{{ open }}</h3>
                </div>
                <div class="kpi-card success">
                    <span>Closed Issues</span>
                    <h3>{{ closed }}</h3>
                </div>
                <div class="kpi-card danger">
                    <span>Issues with CVE</span>
                    <h3>{{ with_cve }}</h3>
                </div>
            </div>
            <!-- CENTER DASHBOARD -->
            <div class="col-xl-8 col-lg-9 col-md-8">
                <!-- ROW 1 -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="panel">
                            <div class="panel-title">Daily Security Trend</div>
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel">
                            <div class="panel-title">Issue Status</div>
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
                <!-- ROW 2 -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="panel">
                            <div class="panel-title">Severity Distribution (CVSS)</div>
                            <canvas id="severityChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel">
                            <div class="panel-title">Top Affected Organizations</div>
                            <canvas id="orgChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- RIGHT INSIGHTS -->
            <div class="col-xl-2 d-none d-xl-block">
                <div class="side-panel">
                    <h6 class="fw-bold">Security Insights</h6>
                    <ul class="insights">
                        <li>
                            <span class="dot danger"></span>{{ with_cve }} issues include CVEs
                        </li>
                        <li>
                            <span class="dot warning"></span>{{ open }} unresolved issues
                        </li>
                        <li>
                            <span class="dot success"></span>{{ closed }} resolved issues
                        </li>
                        <li>
                            <span class="dot info"></span>Continuous monitoring active
                        </li>
                    </ul>
                    <hr>
                    <small class="text-muted">Aggregated security vulnerability data across monitored domains.</small>
                </div>
            </div>
        </div>
    </div>
    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
/* DAILY TREND */
new Chart(document.getElementById("trendChart"), {
  type: "line",
  data: {
    labels: {{ daily_labels|safe }},
    datasets: [
      {
        data: {{ daily_counts|safe }},
        borderColor: "#dc3545",
        backgroundColor: "rgba(220,53,69,0.15)",
        fill: true,
        tension: 0.35,
        pointRadius: 2,
      },
    ],
  },
  options: {
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { display: false } },
      y: { beginAtZero: true },
    },
  },
});

/* ISSUE STATUS */
new Chart(document.getElementById("statusChart"), {
  type: "doughnut",
  data: {
    labels: [{% for s in status_qs %}"{{ s.status|capfirst|default:'Unknown' }}",{% endfor %}],
    datasets: [
      {
        data: [{% for s in status_qs %}{{ s.count }},{% endfor %}],
        backgroundColor: ["#dc3545", "#198754", "#6c757d"],
        borderWidth: 0,
      },
    ],
  },
  options: {
    cutout: "70%",
    plugins: {
      legend: { position: "bottom" },
      tooltip: {
        callbacks: {
          label: function (ctx) {
            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
            const pct = ((ctx.raw / total) * 100).toFixed(1);
            return `${ctx.label}: ${ctx.raw} (${pct}%)`;
          },
        },
      },
    },
  },
});

/* SEVERITY */
new Chart(document.getElementById("severityChart"), {
  type: "bar",
  data: {
    labels: [{% for s in severity_qs %}"{{ s.severity }}",{% endfor %}],
    datasets: [
      {
        data: [{% for s in severity_qs %}{{ s.count }},{% endfor %}],
     backgroundColor: [
  "#dc3545", // Critical - red
  "#fd7e14", // High - orange
  "#ffc107", // Medium - yellow
  "#198754", // Low - green
  "#0dcaf0", // None - blue
  "#6c757d", // Not Scored - gray
],


        borderRadius: 6,
      },
    ],
  },
  options: {
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { display: false } },
      y: { beginAtZero: true },
    },
  },
});

/* ORG */
new Chart(document.getElementById("orgChart"), {
  type: "bar",
  data: {
    labels: [{% for o in org_qs %}"{{ o.domain__name|default:'Unknown' }}",{% endfor %}],
    datasets: [
      {
        data: [{% for o in org_qs %}{{ o.count }},{% endfor %}],
        backgroundColor: "#6f42c1",
        borderRadius: 6,
      },
    ],
  },
  options: {
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { display: false } },
      y: { beginAtZero: true },
    },
  },
});

    </script>
{% endblock %}
