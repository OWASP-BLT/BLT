{% extends "base.html" %}
{% load static %}
{% block content %}
    <link rel="stylesheet"
          type="text/css"
          href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <div class="container mx-auto p-6">
        {% include "includes/sidenav.html" %}
        <div class="main-content w-full py-8">
            <div class="mb-6">
                <h1 class="text-4xl font-semibold text-gray-800 dark:text-gray-200 hover:text-gray-900 dark:hover:text-white text-center">
                    Add Daily Check-In
                </h1>
            </div>
            <!-- Success Message Area (hidden by default) -->
            <div id="success-message"
                 class="mb-6 hidden transition-all duration-300 ease-in-out">
                <div class="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg shadow-sm">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400"
                                 viewBox="0 0 20 20"
                                 fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <h3 class="text-sm font-medium text-green-800 dark:text-green-200"
                                id="success-title">Check-in submitted successfully!</h3>
                            <div id="challenges-completed"
                                 class="mt-2 text-sm text-green-700 dark:text-green-300"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Timer Section - Always visible if there's a last check-in -->
            {% if next_challenge_at %}
                <div class="mb-4 p-4 bg-gradient-to-r from-red-50 to-red-50 dark:from-red-900/20 dark:to-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-xl shadow-md">
                    <div class="flex items-center justify-center space-x-2 px-3 py-2 bg-red-100 dark:bg-red-900/40 rounded-lg border border-red-300 dark:border-red-700">
                        <svg class="w-5 h-5 text-red-600 dark:text-red-400"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        <span class="text-sm font-medium text-red-700 dark:text-red-300">Next challenge in:</span>
                        <span id="countdown-timer"
                              class="text-lg font-bold text-red-800 dark:text-red-200"
                              data-next-challenge="{{ next_challenge_at|date:'c' }}">--:--:--</span>
                    </div>
                </div>
            {% endif %}
            {% if active_challenges %}
                <div class="mb-6 p-5 bg-gradient-to-r from-red-50 to-red-50 dark:from-red-900/20 dark:to-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-xl shadow-md hover:shadow-lg transition-all duration-300">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <h3 class="text-xl font-bold text-red-900 dark:text-red-200">Today's Challenges</h3>
                            <span class="ml-2 px-2 py-1 bg-red-200 dark:bg-red-800 text-red-800 dark:text-red-200 text-xs font-semibold rounded-full">
                                {{ active_challenges|length }} Active
                            </span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        {% for user_challenge in active_challenges %}
                            <div class="flex items-start p-4 bg-white dark:bg-gray-800 rounded-lg border-2 border-red-200 dark:border-red-700 shadow-sm hover:shadow-md hover:border-red-300 dark:hover:border-red-600 transition-all duration-200">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <h4 class="font-semibold text-gray-900 dark:text-gray-200 text-lg">{{ user_challenge.challenge.title }}</h4>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 animate-pulse">
                                            {{ user_challenge.get_status_display }}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 leading-relaxed">{{ user_challenge.challenge.description }}</p>
                                    <div class="mt-3 flex items-center space-x-4">
                                        <div class="flex items-center space-x-1">
                                            <span class="text-yellow-500">‚≠ê</span>
                                            <span class="text-sm font-semibold text-red-600 dark:text-red-400">
                                                +{{ user_challenge.challenge.points_reward }} points
                                            </span>
                                        </div>
                                        {% if user_challenge.challenge.challenge_type == "no_blockers" %}
                                            <span class="text-xs text-gray-500 dark:text-gray-400 italic">Select "No blockers" from dropdown</span>
                                        {% elif user_challenge.challenge.challenge_type == "positive_mood" %}
                                            <span class="text-xs text-gray-500 dark:text-gray-400 italic">Select Happy or Smile</span>
                                        {% elif user_challenge.challenge.challenge_type == "early_checkin" %}
                                            <span class="text-xs text-gray-500 dark:text-gray-400 italic">Submit before 10 AM</span>
                                        {% elif user_challenge.challenge.challenge_type == "complete_all_fields" %}
                                            <span class="text-xs text-gray-500 dark:text-gray-400 italic">Fill all fields completely</span>
                                        {% elif user_challenge.challenge.challenge_type == "detailed_reporter" %}
                                            <span class="text-xs text-gray-500 dark:text-gray-400 italic">Write at least 200 words in "Previous Work"</span>
                                        {% elif user_challenge.challenge.challenge_type == "goal_achiever" %}
                                            <span class="text-xs text-gray-500 dark:text-gray-400 italic">Select "Yes" for goal accomplished</span>
                                        {% elif user_challenge.challenge.challenge_type == "detailed_planner" %}
                                            <span class="text-xs text-gray-500 dark:text-gray-400 italic">Write at least 200 words in "Next Plan"</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            <!-- Completed Challenges Today (if any) -->
            {% if completed_challenges_today %}
                <div id="completed-challenges-section" class="mb-6">
                    <div class="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                        <h3 class="text-lg font-semibold text-green-900 dark:text-green-200 mb-3">‚úÖ Completed Challenges Today</h3>
                        <div id="completed-challenges-list" class="space-y-2">
                            {% for user_challenge in completed_challenges_today %}
                                <div class="flex items-start p-3 bg-white dark:bg-gray-800 rounded border border-green-200 dark:border-green-800">
                                    <div class="flex-1">
                                        <h4 class="font-medium text-gray-900 dark:text-gray-200">‚úÖ {{ user_challenge.challenge.title }}</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ user_challenge.challenge.description }}</p>
                                    </div>
                                    <div class="ml-4">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                                            +{{ user_challenge.points_awarded }} points
                                        </span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% else %}
                <div id="completed-challenges-section" class="mb-6 hidden">
                    <div class="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                        <h3 class="text-lg font-semibold text-green-900 dark:text-green-200 mb-3">‚úÖ Completed Challenges Today</h3>
                        <div id="completed-challenges-list" class="space-y-2"></div>
                    </div>
                </div>
            {% endif %}
            <div class="flex justify-center">
                <form id="checkInForm"
                      method="post"
                      action="{% url 'sizzle_daily_log' %}"
                      class="w-full max-w-5xl bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 space-y-8"
                      {% if not request.user.is_authenticated %}style="display:none;"{% endif %}>
                    {% csrf_token %}
                    <!-- Section 1: Previous Work -->
                    <div class="form-group bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-red-600 to-red-500 flex items-center justify-center text-white font-bold text-lg shadow-md mr-4">
                                1
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label for="previous_work_card"
                                           class="block text-lg font-semibold text-gray-800 dark:text-gray-100">
                                        What did you work on previously?
                                    </label>
                                    <span class="text-red-500 dark:text-red-400 font-semibold text-sm">*</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full">Required</span>
                                </div>
                                <p class="text-xs text-gray-600 dark:text-gray-400 italic">
                                    Tip: Share 200-300 words about your recent PRs, projects, features, or contributions. Be specific!
                                </p>
                            </div>
                        </div>
                        <div class="relative">
                            <textarea id="previous_work_card"
                                      name="previous_work"
                                      rows="5"
                                      placeholder="Describe what you worked on..."
                                      class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-600 dark:focus:border-red-500 transition-all duration-200 shadow-inner"
                                      required
                                      oninput="updateWordCount('previous_work_card', 'previous_work_count')"></textarea>
                            <div class="absolute bottom-3 right-3">
                                <span id="previous_work_count"
                                      class="text-xs text-gray-500 dark:text-gray-400 font-mono bg-white dark:bg-gray-700 px-3 py-1.5 rounded-full shadow-sm border border-gray-200 dark:border-gray-600">0 words</span>
                            </div>
                        </div>
                        {% if yesterday_report %}
                            <button type="button"
                                    id="fillFromPreviousBtn"
                                    class="mt-3 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-300 shadow-sm hover:shadow-md transition-all duration-200 text-sm font-medium">
                                üìã Fill from Previous Check-in
                            </button>
                        {% endif %}
                    </div>
                    <!-- Section 2: Next Plan -->
                    <div class="form-group bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-lg shadow-md mr-4">
                                2
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label for="next_plan_card"
                                           class="block text-lg font-semibold text-gray-800 dark:text-gray-100">
                                        What do you plan to do next?
                                    </label>
                                    <span class="text-red-500 dark:text-red-400 font-semibold text-sm">*</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full">Required</span>
                                </div>
                                <p class="text-xs text-gray-600 dark:text-gray-400 italic">
                                    Tip: Describe your upcoming tasks, goals, or features you're planning to work on (200-300 words).
                                </p>
                            </div>
                        </div>
                        <div class="relative">
                            <textarea id="next_plan_card"
                                      name="next_plan"
                                      rows="5"
                                      placeholder="Describe your upcoming plans..."
                                      class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-600 dark:focus:border-purple-500 transition-all duration-200 shadow-inner"
                                      required
                                      oninput="updateWordCount('next_plan_card', 'next_plan_count')"></textarea>
                            <div class="absolute bottom-3 right-3">
                                <span id="next_plan_count"
                                      class="text-xs text-gray-500 dark:text-gray-400 font-mono bg-white dark:bg-gray-700 px-3 py-1.5 rounded-full shadow-sm border border-gray-200 dark:border-gray-600">0 words</span>
                            </div>
                        </div>
                    </div>
                    <!-- Section 3: Blockers -->
                    <div class="form-group bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-orange-500 to-red-500 flex items-center justify-center text-white font-bold text-lg shadow-md mr-4">
                                3
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label for="blockers_card"
                                           class="block text-lg font-semibold text-gray-800 dark:text-gray-100">
                                        Do you have any blockers?
                                    </label>
                                    <span class="text-red-500 dark:text-red-400 font-semibold text-sm">*</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full">Required</span>
                                </div>
                                <p class="text-xs text-gray-600 dark:text-gray-400 italic">
                                    Tip: Select "No blockers" to complete the "Smooth Sailing" challenge!
                                </p>
                            </div>
                        </div>
                        <select id="blockers_card"
                                name="blockers"
                                required
                                class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-600 dark:focus:border-orange-500 transition-all duration-200 shadow-inner text-base">
                            <option value="">Select an option...</option>
                            <option value="no_blockers">‚úÖ No blockers - All good!</option>
                            <option value="technical">üîß Technical issues</option>
                            <option value="dependency">‚è≥ Waiting on dependencies</option>
                            <option value="clarification">‚ùì Need clarification</option>
                            <option value="resource">üìö Need more resources</option>
                            <option value="other">üìù Other (specify below)</option>
                        </select>
                        <textarea id="blockers_other"
                                  name="blockers_other"
                                  rows="3"
                                  placeholder="If you selected 'Other', please describe your blockers here..."
                                  class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-600 dark:focus:border-orange-500 transition-all duration-200 mt-3 hidden shadow-inner"></textarea>
                    </div>
                    <!-- Yesterday's Context -->
                    {% if yesterday_report %}
                        <div class="bg-gradient-to-r from-red-50 to-red-50 dark:from-red-900/30 dark:to-red-900/30 border-2 border-red-200 dark:border-red-800 rounded-xl p-5 shadow-sm">
                            <h3 class="text-sm font-semibold text-red-900 dark:text-red-200 mb-3 flex items-center">
                                <span class="mr-2">üìÖ</span>
                                Yesterday's Context
                            </h3>
                            <div class="space-y-2 text-sm">
                                <p class="text-gray-700 dark:text-gray-300">
                                    <strong class="text-red-800 dark:text-red-300">Yesterday's plan:</strong>
                                    <span class="text-gray-600 dark:text-gray-400">{{ yesterday_report.next_plan|truncatewords:30 }}</span>
                                </p>
                                <p class="text-gray-700 dark:text-gray-300">
                                    <strong class="text-red-800 dark:text-red-300">Yesterday's blockers:</strong>
                                    <span class="text-gray-600 dark:text-gray-400">{{ yesterday_report.blockers|truncatewords:20 }}</span>
                                </p>
                            </div>
                        </div>
                    {% else %}
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 border-2 border-gray-200 dark:border-gray-700 rounded-xl p-5 shadow-sm">
                            {% if last_checkin %}
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                    No report available for yesterday. Last check-in was on <strong>{{ last_checkin.date|date:"F d, Y" }}</strong>.
                                </p>
                                <button type="button"
                                        id="fillFromLastCheckinBtn"
                                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-300 shadow-sm hover:shadow-md transition-all duration-200 text-sm font-medium">
                                    üìã Fill from Last Check-in
                                </button>
                            {% else %}
                                <p class="text-sm text-gray-600 dark:text-gray-400">No previous check-ins available.</p>
                            {% endif %}
                        </div>
                    {% endif %}
                    <!-- Section 4: Goal Accomplished -->
                    <div class="form-group bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center text-white font-bold text-lg shadow-md mr-4">
                                4
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="block text-lg font-semibold text-gray-800 dark:text-gray-100">
                                        Did you accomplish your goals for yesterday?
                                    </label>
                                    <span class="text-red-500 dark:text-red-400 font-semibold text-sm">*</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full">Required</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-6 ml-14">
                            <label class="flex items-center cursor-pointer group">
                                <input type="radio"
                                       id="goal_yes"
                                       name="goal_accomplished"
                                       value="yes"
                                       class="w-5 h-5 text-green-500 border-2 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:bg-gray-800 dark:border-gray-600 cursor-pointer transition-all duration-200"
                                       required>
                                <span class="ml-3 text-base font-medium text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-gray-100">Yes</span>
                            </label>
                            <label class="flex items-center cursor-pointer group">
                                <input type="radio"
                                       id="goal_no"
                                       name="goal_accomplished"
                                       value="no"
                                       class="w-5 h-5 text-red-500 border-2 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:bg-gray-800 dark:border-gray-600 cursor-pointer transition-all duration-200"
                                       required>
                                <span class="ml-3 text-base font-medium text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-gray-100">No</span>
                            </label>
                        </div>
                    </div>
                    <!-- Section 5: Mood Selection -->
                    <div class="form-group bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-yellow-500 to-amber-500 flex items-center justify-center text-white font-bold text-lg shadow-md mr-4">
                                5
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label for="feeling_card"
                                           class="block text-lg font-semibold text-gray-800 dark:text-gray-100">
                                        How are you feeling today?
                                    </label>
                                    <span class="text-red-500 dark:text-red-400 font-semibold text-sm">*</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full">Required</span>
                                </div>
                                <p class="text-xs text-gray-600 dark:text-gray-400 italic">
                                    Tip: Select Happy or Smile to complete the "Stay Positive" challenge!
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center justify-center space-x-3 p-6 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 shadow-inner">
                            <input type="radio"
                                   id="mood_1"
                                   name="feeling"
                                   value="üòä"
                                   class="hidden peer/mood_1"
                                   required>
                            <label for="mood_1"
                                   class="flex flex-col items-center justify-center cursor-pointer p-5 rounded-xl border-2 border-transparent hover:border-red-400 dark:hover:border-red-500 peer-checked/mood_1:border-red-500 dark:peer-checked/mood_1:border-red-400 peer-checked/mood_1:bg-gradient-to-br peer-checked/mood_1:from-red-50 peer-checked/mood_1:to-red-100 dark:peer-checked/mood_1:from-red-900/40 dark:peer-checked/mood_1:to-red-800/40 peer-checked/mood_1:shadow-lg transition-all duration-300 hover:scale-110 active:scale-95 hover:shadow-md min-w-[90px]">
                                <span class="text-5xl mb-3 filter drop-shadow-lg block">üòä</span>
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-200 block text-center">Happy</span>
                            </label>
                            <input type="radio"
                                   id="mood_2"
                                   name="feeling"
                                   value="üòÑ"
                                   class="hidden peer/mood_2"
                                   required>
                            <label for="mood_2"
                                   class="flex flex-col items-center justify-center cursor-pointer p-5 rounded-xl border-2 border-transparent hover:border-red-400 dark:hover:border-red-500 peer-checked/mood_2:border-red-500 dark:peer-checked/mood_2:border-red-400 peer-checked/mood_2:bg-gradient-to-br peer-checked/mood_2:from-red-50 peer-checked/mood_2:to-red-100 dark:peer-checked/mood_2:from-red-900/40 dark:peer-checked/mood_2:to-red-800/40 peer-checked/mood_2:shadow-lg transition-all duration-300 hover:scale-110 active:scale-95 hover:shadow-md min-w-[90px]">
                                <span class="text-5xl mb-3 filter drop-shadow-lg block">üòÑ</span>
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-200 block text-center">Smile</span>
                            </label>
                            <input type="radio"
                                   id="mood_3"
                                   name="feeling"
                                   value="üòê"
                                   class="hidden peer/mood_3"
                                   required>
                            <label for="mood_3"
                                   class="flex flex-col items-center justify-center cursor-pointer p-5 rounded-xl border-2 border-transparent hover:border-gray-400 dark:hover:border-gray-500 peer-checked/mood_3:border-gray-500 dark:peer-checked/mood_3:border-gray-400 peer-checked/mood_3:bg-gradient-to-br peer-checked/mood_3:from-gray-100 peer-checked/mood_3:to-gray-200 dark:peer-checked/mood_3:from-gray-700 dark:peer-checked/mood_3:to-gray-800 peer-checked/mood_3:shadow-lg transition-all duration-300 hover:scale-110 active:scale-95 hover:shadow-md min-w-[90px]">
                                <span class="text-5xl mb-3 filter drop-shadow-lg block">üòê</span>
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-200 block text-center">Okay</span>
                            </label>
                            <input type="radio"
                                   id="mood_4"
                                   name="feeling"
                                   value="üòî"
                                   class="hidden peer/mood_4"
                                   required>
                            <label for="mood_4"
                                   class="flex flex-col items-center justify-center cursor-pointer p-5 rounded-xl border-2 border-transparent hover:border-yellow-400 dark:hover:border-yellow-500 peer-checked/mood_4:border-yellow-500 dark:peer-checked/mood_4:border-yellow-400 peer-checked/mood_4:bg-gradient-to-br peer-checked/mood_4:from-yellow-50 peer-checked/mood_4:to-yellow-100 dark:peer-checked/mood_4:from-yellow-900/40 dark:peer-checked/mood_4:to-yellow-800/40 peer-checked/mood_4:shadow-lg transition-all duration-300 hover:scale-110 active:scale-95 hover:shadow-md min-w-[90px]">
                                <span class="text-5xl mb-3 filter drop-shadow-lg block">üòî</span>
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-200 block text-center">Sad</span>
                            </label>
                            <input type="radio"
                                   id="mood_5"
                                   name="feeling"
                                   value="üò†"
                                   class="hidden peer/mood_5"
                                   required>
                            <label for="mood_5"
                                   class="flex flex-col items-center justify-center cursor-pointer p-5 rounded-xl border-2 border-transparent hover:border-red-400 dark:hover:border-red-500 peer-checked/mood_5:border-red-500 dark:peer-checked/mood_5:border-red-400 peer-checked/mood_5:bg-gradient-to-br peer-checked/mood_5:from-red-50 peer-checked/mood_5:to-red-100 dark:peer-checked/mood_5:from-red-900/40 dark:peer-checked/mood_5:to-red-800/40 peer-checked/mood_5:shadow-lg transition-all duration-300 hover:scale-110 active:scale-95 hover:shadow-md min-w-[90px]">
                                <span class="text-5xl mb-3 filter drop-shadow-lg block">üò†</span>
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-200 block text-center">Angry</span>
                            </label>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit"
                                class="submit-button bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-300 focus:ring-offset-2">
                            Submit Check-in
                        </button>
                    </div>
                </form>
            </div>
            <!-- Check-ins Summary Table -->
            <div class="mt-12">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Your Check-in History</h2>
                    <span class="px-3 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-sm font-semibold rounded-full">
                        {{ all_checkins|length }} Total
                    </span>
                </div>
                {% if all_checkins %}
                    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gradient-to-r from-red-600 to-red-500">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Date & Time</th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Goals</th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Mood</th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Blockers</th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Previous Work</th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Next Plan</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    {% for checkin in all_checkins %}
                                        <tr class="hover:bg-red-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ checkin.date|date:"M d, Y" }}</div>
                                                <div class="text-xs text-gray-500 dark:text-gray-400">{{ checkin.created|date:"g:i A" }}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                {% if checkin.goal_accomplished %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                                                        Yes
                                                    </span>
                                                {% else %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">
                                                        No
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="text-2xl">{{ checkin.current_mood }}</span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm text-gray-900 dark:text-gray-100 max-w-xs truncate"
                                                     title="{{ checkin.blockers }}">
                                                    {{ checkin.blockers|truncatewords:8|default:"None" }}
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm text-gray-900 dark:text-gray-100 max-w-xs">
                                                    <p class="truncate" title="{{ checkin.previous_work }}">{{ checkin.previous_work|truncatewords:12|default:"‚Äî" }}</p>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm text-gray-900 dark:text-gray-100 max-w-xs">
                                                    <p class="truncate" title="{{ checkin.next_plan }}">{{ checkin.next_plan|truncatewords:12|default:"‚Äî" }}</p>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% else %}
                    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-xl p-12 border border-gray-200 dark:border-gray-700 text-center">
                        <div class="text-6xl mb-4">üìù</div>
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">No Check-ins Yet</h3>
                        <p class="text-gray-600 dark:text-gray-400">Start your journey by submitting your first check-in above!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
        // Countdown timer for next challenge
        function updateCountdown() {
            const timerElement = document.getElementById('countdown-timer');
            if (!timerElement) return;
            
            const nextChallengeStr = timerElement.getAttribute('data-next-challenge');
            if (!nextChallengeStr || nextChallengeStr.trim() === '') {
                timerElement.textContent = 'Available now!';
                timerElement.classList.add('text-green-600', 'dark:text-green-400');
                return;
            }
            
            const nextChallengeTime = new Date(nextChallengeStr);
            const now = new Date();
            const diff = nextChallengeTime - now;
            
            if (diff <= 0) {
                timerElement.textContent = 'Available now!';
                timerElement.classList.add('text-green-600', 'dark:text-green-400');
                timerElement.classList.remove('text-red-800', 'dark:text-red-200');
                return;
            }
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timerElement.classList.remove('text-green-600', 'dark:text-green-400');
            timerElement.classList.add('text-red-800', 'dark:text-red-200');
        }
        
        // Update countdown every second
        if (document.getElementById('countdown-timer')) {
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // Word count function
        function updateWordCount(textareaId, countId) {
            const textarea = document.getElementById(textareaId);
            const countElement = document.getElementById(countId);
            if (textarea && countElement) {
                const text = textarea.value.trim();
                const wordCount = text === '' ? 0 : text.split(/\s+/).filter(word => word.length > 0).length;
                countElement.textContent = `${wordCount} words`;
                
                // Color coding based on word count
                if (wordCount < 50) {
                    countElement.className = 'text-xs text-gray-400 dark:text-gray-500 font-mono bg-white dark:bg-gray-800 px-2 py-1 rounded';
                } else if (wordCount < 200) {
                    countElement.className = 'text-xs text-yellow-600 dark:text-yellow-400 font-mono bg-yellow-50 dark:bg-yellow-900/20 px-2 py-1 rounded';
                } else if (wordCount < 300) {
                    countElement.className = 'text-xs text-green-600 dark:text-green-400 font-mono bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded';
                } else {
                    countElement.className = 'text-xs text-red-600 dark:text-red-400 font-mono bg-red-50 dark:bg-red-900/20 px-2 py-1 rounded';
                }
            }
        }

        // Initialize word counts on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateWordCount('previous_work_card', 'previous_work_count');
            updateWordCount('next_plan_card', 'next_plan_count');
            
            // Handle blockers dropdown - show "other" textarea when "other" is selected
            const blockersSelect = document.getElementById('blockers_card');
            const blockersOther = document.getElementById('blockers_other');
            if (blockersSelect && blockersOther) {
                blockersSelect.addEventListener('change', function() {
                    if (this.value === 'other') {
                        blockersOther.classList.remove('hidden');
                        blockersOther.required = true;
                    } else {
                        blockersOther.classList.add('hidden');
                        blockersOther.required = false;
                        blockersOther.value = '';
                    }
                });
            }

            {% if yesterday_report %}
            // Fill from previous check-in button functionality
            const fillFromPreviousBtn = document.getElementById('fillFromPreviousBtn');
            if (fillFromPreviousBtn) {
                fillFromPreviousBtn.addEventListener('click', () => {
                    const previousWorkTextarea = document.getElementById('previous_work_card');
                    previousWorkTextarea.value = "{{ yesterday_report.next_plan|escapejs }}";
                    previousWorkTextarea.focus();
                });
            }
            {% endif %}

            {% if last_checkin %}
            // Fill from last check-in button functionality (when no yesterday report)
            const fillFromLastCheckinBtn = document.getElementById('fillFromLastCheckinBtn');
            if (fillFromLastCheckinBtn) {
                fillFromLastCheckinBtn.addEventListener('click', () => {
                    const previousWorkTextarea = document.getElementById('previous_work_card');
                    previousWorkTextarea.value = "{{ last_checkin.next_plan|escapejs }}";
                    previousWorkTextarea.focus();
                });
            }
            {% endif %}

            // Handle form submission
            const checkInForm = document.getElementById('checkInForm');
            if (checkInForm) {
                checkInForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(checkInForm);
                    const submitButton = checkInForm.querySelector('button[type="submit"]');
                    const originalText = submitButton.textContent.trim();
                    
                    // Disable submit button
                    submitButton.disabled = true;
                    submitButton.textContent = 'Submitting...';
                    
                    // Helper function to escape HTML to prevent XSS
                    function escapeHtml(text) {
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    }
                    
                    // Helper function to create a challenge item element
                    function createChallengeItem(challenge) {
                        const item = document.createElement('div');
                        item.className = 'flex items-center justify-between p-2 bg-green-100 dark:bg-green-900/30 rounded';
                        
                        const titleSpan = document.createElement('span');
                        titleSpan.className = 'text-sm font-medium text-green-800 dark:text-green-200';
                        titleSpan.textContent = challenge.title;
                        
                        const pointsSpan = document.createElement('span');
                        pointsSpan.className = 'text-sm font-bold text-green-600 dark:text-green-400';
                        pointsSpan.textContent = '+' + challenge.points + ' points';
                        
                        item.appendChild(titleSpan);
                        item.appendChild(pointsSpan);
                        
                        return item;
                    }
                    
                    // Helper function to create a completed challenge item element
                    function createCompletedChallengeItem(challenge) {
                        const item = document.createElement('div');
                        item.className = 'flex items-start p-3 bg-white dark:bg-gray-800 rounded border border-green-200 dark:border-green-800';
                        
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'flex-1';
                        
                        const titleH4 = document.createElement('h4');
                        titleH4.className = 'font-medium text-gray-900 dark:text-gray-200';
                        titleH4.textContent = '‚úÖ ' + challenge.title;
                        
                        const descP = document.createElement('p');
                        descP.className = 'text-sm text-gray-600 dark:text-gray-400 mt-1';
                        descP.textContent = challenge.description;
                        
                        contentDiv.appendChild(titleH4);
                        contentDiv.appendChild(descP);
                        
                        const pointsDiv = document.createElement('div');
                        pointsDiv.className = 'ml-4';
                        
                        const pointsSpan = document.createElement('span');
                        pointsSpan.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
                        pointsSpan.textContent = '+' + challenge.points + ' points';
                        
                        pointsDiv.appendChild(pointsSpan);
                        
                        item.appendChild(contentDiv);
                        item.appendChild(pointsDiv);
                        
                        return item;
                    }
                    
                    try {
                        const response = await fetch(checkInForm.action, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success === 'true') {
                            // Show success message first, then reload immediately
                            const successMessage = document.getElementById('success-message');
                            const successTitle = document.getElementById('success-title');
                            const challengesCompleted = document.getElementById('challenges-completed');
                            
                            if (data.completed_challenges && data.completed_challenges.length > 0) {
                                successTitle.textContent = `üéâ Great job! You completed ${data.completed_challenges.length} challenge(s)!`;
                                
                                // Clear existing content
                                challengesCompleted.textContent = '';
                                
                                const containerDiv = document.createElement('div');
                                containerDiv.className = 'mt-2 space-y-1';
                                
                                data.completed_challenges.forEach(challenge => {
                                    containerDiv.appendChild(createChallengeItem(challenge));
                                });
                                
                                if (data.total_points > 0) {
                                    const totalDiv = document.createElement('div');
                                    totalDiv.className = 'mt-2 pt-2 border-t border-green-200 dark:border-green-700';
                                    
                                    const totalInnerDiv = document.createElement('div');
                                    totalInnerDiv.className = 'flex items-center justify-between';
                                    
                                    const totalLabel = document.createElement('span');
                                    totalLabel.className = 'text-sm font-semibold text-green-800 dark:text-green-200';
                                    totalLabel.textContent = 'Total Points Awarded:';
                                    
                                    const totalPoints = document.createElement('span');
                                    totalPoints.className = 'text-lg font-bold text-green-600 dark:text-green-400';
                                    totalPoints.textContent = '+' + data.total_points + ' points';
                                    
                                    totalInnerDiv.appendChild(totalLabel);
                                    totalInnerDiv.appendChild(totalPoints);
                                    totalDiv.appendChild(totalInnerDiv);
                                    containerDiv.appendChild(totalDiv);
                                }
                                
                                challengesCompleted.appendChild(containerDiv);
                            } else {
                                successTitle.textContent = '‚úÖ Check-in submitted successfully!';
                                challengesCompleted.textContent = '';
                            }
                            
                            // Show success message with smooth animation
                            successMessage.classList.remove('hidden');
                            successMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            
                            // Update completed challenges section
                            if (data.completed_challenges && data.completed_challenges.length > 0) {
                                const completedSection = document.getElementById('completed-challenges-section');
                                const completedList = document.getElementById('completed-challenges-list');
                                
                                // Clear existing content
                                completedList.textContent = '';
                                
                                data.completed_challenges.forEach(challenge => {
                                    completedList.appendChild(createCompletedChallengeItem(challenge));
                                });
                                
                                completedSection.classList.remove('hidden');
                            }
                            
                            // Reset form
                            checkInForm.reset();
                            
                            // Reload page immediately to show updated points and "already submitted" state
                            // Use cache-busting to ensure fresh data is loaded
                            setTimeout(() => {
                                window.location.reload(true); // Force reload from server
                            }, 500);
                        } else {
                            // Show error message inline instead of alert
                            const successMessage = document.getElementById('success-message');
                            const successTitle = document.getElementById('success-title');
                            const challengesCompleted = document.getElementById('challenges-completed');
                            
                            successMessage.classList.remove('bg-green-50', 'border-green-200', 'dark:bg-green-900/20', 'dark:border-green-800');
                            successMessage.classList.add('bg-red-50', 'border-red-200', 'dark:bg-red-900/20', 'dark:border-red-800');
                            
                            successTitle.textContent = '‚ùå Error Submitting Check-in';
                            successTitle.classList.remove('text-green-800', 'dark:text-green-200');
                            successTitle.classList.add('text-red-800', 'dark:text-red-200');
                            
                            // Clear existing content and create error message using DOM methods
                            challengesCompleted.textContent = '';
                            const errorP = document.createElement('p');
                            errorP.className = 'text-sm text-red-700 dark:text-red-300';
                            errorP.textContent = data.message || 'An error occurred. Please try again.';
                            challengesCompleted.appendChild(errorP);
                            
                            successMessage.classList.remove('hidden');
                            successMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        // Show error message inline instead of alert
                        const successMessage = document.getElementById('success-message');
                        const successTitle = document.getElementById('success-title');
                        const challengesCompleted = document.getElementById('challenges-completed');
                        
                        successMessage.classList.remove('bg-green-50', 'border-green-200', 'dark:bg-green-900/20', 'dark:border-green-800');
                        successMessage.classList.add('bg-red-50', 'border-red-200', 'dark:bg-red-900/20', 'dark:border-red-800');
                        
                        successTitle.textContent = '‚ùå Error Submitting Check-in';
                        successTitle.classList.remove('text-green-800', 'dark:text-green-200');
                        successTitle.classList.add('text-red-800', 'dark:text-red-200');
                        
                        // Clear existing content and create error message using DOM methods
                        challengesCompleted.textContent = '';
                        const errorP = document.createElement('p');
                        errorP.className = 'text-sm text-red-700 dark:text-red-300';
                        errorP.textContent = 'An error occurred. Please try again.';
                        challengesCompleted.appendChild(errorP);
                        
                        // Also show error via createMessage if available
                        if (typeof window.createMessage === 'function') {
                            window.createMessage(
                                'Failed to submit check-in: ' + (error.message || 'Unknown error'),
                                'error',
                                8000
                            );
                        }
                        
                        // Re-enable submit button for retry
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                        
                        successMessage.classList.remove('hidden');
                        successMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } finally {
                        // Re-enable submit button
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                });
            }
        });
    </script>
{% endblock content %}
