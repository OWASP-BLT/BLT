{% extends "base.html" %}
{% load static %}
{% block content %}
    <link rel="stylesheet"
          type="text/css"
          href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <style>
    .docs_style {
        background-color: #EF4444!important;
        color: white!important;
    }
    .docs_style:hover {
        background-color: #dc2626!important;
    }
    .disabled-button {
        background-color: #a1a1aa !important;
        cursor: not-allowed !important;
    }
    </style>
    <div class="container mx-auto p-6">
        {% include "includes/sidenav.html" %}
        <div class="main-content w-full py-8">
            <!-- Heading -->
            <div class="mb-6">
                <h1 class="text-4xl font-semibold text-gray-800 text-center">Add Sizzle Check-In</h1>
            </div>
        
            <!-- Form Section -->
            <div class="flex justify-center">
                <form id="checkInForm"
                      method="post"
                      action="{% url 'sizzle_daily_log' %}"
                      class="w-full max-w-5xl bg-white shadow-sm rounded-lg p-6"
                      {% if not request.user.is_authenticated %}style="display:none;"{% endif %}>
                    {% csrf_token %}
                    
                    <!-- Previous Work -->
                    <div class="form-group mb-10">
                        <label for="previous_work_card" class="block text-gray-700 font-medium mb-2">
                            What did you work on previously?
                        </label>
                        <textarea id="previous_work_card" 
                                  name="previous_work" 
                                  rows="5" 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" 
                                  required></textarea>
                    </div>
        
                    <!-- Next Plan -->
                    <div class="form-group mb-10">
                        <label for="next_plan_card" class="block text-gray-700 font-medium mb-2">
                            What do you plan to do next?
                        </label>
                        <textarea id="next_plan_card" 
                                  name="next_plan" 
                                  rows="5" 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" 
                                  required></textarea>
                    </div>
        
                    <!-- Blockers -->
                    <div class="form-group mb-10">
                        <label for="blockers_card" class="block text-gray-700 font-medium mb-2">
                            Do you have any blockers?
                        </label>
                        <textarea id="blockers_card" 
                                  name="blockers" 
                                  rows="5" 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                    </div>
        
                    <!-- Submit Button -->
                    <div class="text-center">
                        <button type="submit" 
                                class="submit-button bg-red-500 text-white font-bold py-2 px-6 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                            Submit
                        </button>
                    </div>
                </form>
            </div>
        </div>        
    </div>
    <script src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
$(function() {
    // Use the default_start_date and default_end_date from the backend if provided
    const defaultStart = "{{ default_start_date }}";
    const defaultEnd = "{{ default_end_date }}";

    // Initialize date range picker with default dates
    $('#daterange').daterangepicker({
        opens: 'left',
        locale: {
            format: 'YYYY-MM-DD'
        },
        startDate: defaultStart,
        endDate: defaultEnd
    }, function(start, end) {
        $('#report-title').text(`Check-In Reports from ${start.format('D MMM YYYY')} to ${end.format('D MMM YYYY')}`);

        // AJAX call to fetch check-in details for the selected date range
        $.ajax({
            url: '{% url "checkIN" %}',
            data: {
                start_date: start.format('YYYY-MM-DD'),
                end_date: end.format('YYYY-MM-DD')
            },
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function(data) {
                $('#report-container').empty();

                if (data.length === 0) {
                    $('#report-container').append(`
                        <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-8">
                            <div class="bg-red-500 text-white text-center py-4 text-lg font-semibold border-b border-gray-400">
                                No Data
                            </div>
                            <div class="p-4 text-gray-600">No check-in reports found for the selected range.</div>
                        </div>
                    `);
                    return;
                }

                // Group data by date
                const reportsByDate = {};
                data.forEach(item => {
                    if (!reportsByDate[item.date]) {
                        reportsByDate[item.date] = [];
                    }
                    reportsByDate[item.date].push(item);
                });

                // Render each date's report
                for (const reportDate in reportsByDate) {
                    const dayReports = reportsByDate[reportDate];

                    let rows = '';
                    dayReports.forEach(item => {
                        const detailUrl = "/check-in/" + item.id + "/"; // Construct URL directly
                        rows += `
                            <tr class="hover:bg-gray-50">
                                <td class="py-3 px-4 border-b border-gray-200">${item.username}</td>
                                <td class="py-3 px-4 border-b border-gray-200">${item.previous_work}</td>
                                <td class="py-3 px-4 border-b border-gray-200">${item.next_plan}</td>
                                <td class="py-3 px-4 border-b border-gray-200">${item.blockers}</td>
                                <td class="py-3 px-4 border-b border-gray-200">
                                    <a href="${detailUrl}" class="bg-red-500 text-white py-1 px-3 rounded hover:bg-red-600">View</a>
                                </td>
                            </tr>
                        `;
                    });

                    $('#report-container').append(`
                        <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-8">
                            <div class="bg-red-500 text-white text-center py-4 text-lg font-semibold border-b border-gray-400">
                                ${reportDate}
                            </div>
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-red-500 text-white text-sm uppercase tracking-wider">
                                        <th class="text-left py-3 px-4 border-b border-gray-200">Username</th>
                                        <th class="text-left py-3 px-4 border-b border-gray-200">Previous Work</th>
                                        <th class="text-left py-3 px-4 border-b border-gray-200">Next Plan</th>
                                        <th class="text-left py-3 px-4 border-b border-gray-200">Blockers</th>
                                        <th class="text-left py-3 px-4 border-b border-gray-200">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    `);
                }
            },
            error: function() {
                alert('An error occurred while fetching the check-in details.');
            }
        });
    });

    // Trigger initial load
    $('#daterange').trigger('apply.daterangepicker');
});
    </script>
{% endblock content %}
