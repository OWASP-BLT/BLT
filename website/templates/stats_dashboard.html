{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% block title %}
    Statistics Dashboard
{% endblock title %}

{% block extra_head %}
<script>
    // Define page-specific APIs to precache
    window.PAGE_APIS = [
        '/api/v1/stats/',
        '/api/v1/leaderboard/'
    ];
</script>
{% endblock %}

{% block content %}
    {% include "includes/sidenav.html" %}
    <div id="mainContent"
         class="p-4 sm:p-6 lg:p-8 mt-[160px] transition-all duration-300">
        <div class="flex flex-col space-y-4 mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-900">Statistics Dashboard</h1>
            </div>
            <!-- Time Period Selector -->
            <div class="flex flex-wrap gap-2 items-center bg-white p-4 rounded-lg shadow-sm">
                <span class="text-gray-700 font-medium">Time Period:</span>
                {% for option in period_options %}
                    <a href="?period={{ option.value }}"
                       class="px-4 py-2 rounded-md text-sm font-medium {% if period == option.value %}bg-[#e74c3c] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors duration-200">
                        {{ option.label }}
                    </a>
                {% endfor %}
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div id="stats-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 2xl:grid-cols-6 gap-4">
            <!-- Stats will be loaded here -->
            <!-- Loading placeholder -->
            <div class="col-span-full text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#e74c3c]"></div>
                <p class="mt-2 text-gray-600">Loading statistics...</p>
            </div>
        </div>
        
        <!-- Rest of the content -->
        
        <!-- ... existing code ... -->
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statsContainer = document.getElementById('stats-container');
        const period = new URLSearchParams(window.location.search).get('period') || 'month';
        
        // Function to load stats
        async function loadStats() {
            try {
                // Use our API cache utility
                const stats = await ApiCache.fetch(`/api/v1/stats/?period=${period}`);
                
                // Check if data is from cache
                if (stats._fromCache) {
                    NetworkStatus.showCachedDataMessage('statistics', stats._cachedAt);
                }
                
                // Render stats
                renderStats(stats);
            } catch (error) {
                console.error('Error loading stats:', error);
                statsContainer.innerHTML = `
                    <div class="col-span-full bg-red-50 p-4 rounded-lg border border-red-200">
                        <p class="text-red-700 text-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Unable to load statistics. Please try again later.
                        </p>
                    </div>
                `;
            }
        }
        
        // Function to render stats
        function renderStats(data) {
            // Create HTML for stats widgets
            const statsHtml = `
                <!-- Users Widget -->
                <div class="bg-white rounded-lg border-2 border-gray-300 p-3 hover:shadow-md transition-shadow w-[100px] h-[100px] flex flex-col justify-between">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold text-gray-800">Users</h3>
                        <i class="fa fa-users text-xl text-[#e74c3c]"></i>
                    </div>
                    <div class="text-2xl font-bold text-gray-900 w-full text-center">${data.users || 0}</div>
                </div>
                
                <!-- Issues Widget -->
                <div class="bg-white rounded-lg border-2 border-gray-300 p-3 hover:shadow-md transition-shadow w-[100px] h-[100px] flex flex-col justify-between">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold text-gray-800">Issues</h3>
                        <i class="fa fa-bug text-xl text-[#e74c3c]"></i>
                    </div>
                    <div class="text-2xl font-bold text-gray-900 w-full text-center">${data.bugs || 0}</div>
                </div>
                
                <!-- Domains Widget -->
                <div class="bg-white rounded-lg border-2 border-gray-300 p-3 hover:shadow-md transition-shadow w-[100px] h-[100px] flex flex-col justify-between">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold text-gray-800">Domains</h3>
                        <i class="fa fa-globe text-xl text-[#e74c3c]"></i>
                    </div>
                    <div class="text-2xl font-bold text-gray-900 w-full text-center">${data.domains || 0}</div>
                </div>
                
                <!-- Hunts Widget -->
                <div class="bg-white rounded-lg border-2 border-gray-300 p-3 hover:shadow-md transition-shadow w-[100px] h-[100px] flex flex-col justify-between">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold text-gray-800">Hunts</h3>
                        <i class="fa fa-search text-xl text-[#e74c3c]"></i>
                    </div>
                    <div class="text-2xl font-bold text-gray-900 w-full text-center">${data.hunts || 0}</div>
                </div>
            `;
            
            // Update the container
            statsContainer.innerHTML = statsHtml;
        }
        
        // Load stats
        loadStats();
    });
</script>
{% endblock %}
