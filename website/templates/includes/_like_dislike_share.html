{% load gravatar %}
{% load custom_tags %}
<!-- Modern redesigned like/dislike/share component -->
<div class="flex flex-wrap gap-x-3 w-full items-center border-y border-gray-300 dark:border-gray-600 py-6 my-3">
    <!-- HTMX fragment for like/dislike/flag -->
    {% include "includes/_like_section.html" with object=object positive_votes=positive_votes|default:likes negative_votes=negative_votes|default:dislikes flags_count=flags_count|default:flags user_vote=user_vote user_has_flagged=user_has_flagged|default:isFlagged %}
    <!-- Share button (static) -->
    <button onclick="copyClipboard()"
            class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
        <i class="fa-solid fa-share-nodes text-gray-400"></i>
        <span class="font-semibold">Share</span>
    </button>
    <!-- View buttons section -->
    <div class="flex items-center gap-4">
        <!-- View Flags button -->
        {% if flagers %}
            <button onclick="openFlagModal()"
                    class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100">
                View Flags
            </button>
        {% endif %}
        <!-- View Likes button -->
        {% if likers %}
            <button onclick="openLikeModal()"
                    class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100">
                View Likes
            </button>
        {% endif %}
    </div>
    <!-- Bookmark section for HTMX updates -->
    <div id="bookmark-section-{{ object.id }}" class="flex items-center">
        <!-- This div is for HTMX updates from bookmark button -->
    </div>
</div>
{% include "includes/_like_modal.html" %}
{% include "includes/_flag_modal.html" %}
<script>
    // SAFE Clipboard function with browser compatibility checks
    function copyClipboard() {
        var textToCopy = "Bug Found on @{{ object.domain_title|escapejs }} - {{ object.description|escapejs }} Report: https://{% env 'FQDN' %}/issue/{{ object.id }}";

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textToCopy)
                .then(function () {
                    if (window.createMessage) {
                        window.createMessage("Bug details copied to clipboard!", "success", 3000);
                    } else {
                        // Fallback notification
                        alert("Bug details copied to clipboard!");
                    }
                })
                .catch(function (err) {
                    console.error("Failed to copy:", err);
                    // Fallback for older browsers or non-secure contexts
                    alert("Bug details copied to clipboard!");
                });
        } else {
            // Fallback for browsers without clipboard API
            alert("Bug details copied to clipboard!");
        }
    }
    
    // Modal functions
    function openLikeModal() {
        document.getElementById('like-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeLikeModal() {
        document.getElementById('like-modal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    function openFlagModal() {
        document.getElementById('flag-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeFlagModal() {
        document.getElementById('flag-modal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    // Close modals when clicking outside or pressing Escape
    document.addEventListener('DOMContentLoaded', function() {
        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            const likeModal = document.getElementById('like-modal');
            const flagModal = document.getElementById('flag-modal');
            
            if (likeModal && !likeModal.classList.contains('hidden')) {
                if (event.target === likeModal) {
                    closeLikeModal();
                }
            }
            
            if (flagModal && !flagModal.classList.contains('hidden')) {
                if (event.target === flagModal) {
                    closeFlagModal();
                }
            }
        });
        
        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const likeModal = document.getElementById('like-modal');
                const flagModal = document.getElementById('flag-modal');
                
                if (likeModal && !likeModal.classList.contains('hidden')) {
                    closeLikeModal();
                }
                
                if (flagModal && !flagModal.classList.contains('hidden')) {
                    closeFlagModal();
                }
            }
        });
    });
</script>
