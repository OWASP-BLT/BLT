{% extends "base.html" %}
{% load static %}
{% block title %}{{ video.title }} - Quiz{% endblock %}
{% block content %}
    <div class="container mx-auto mt-10 max-w-4xl">
        <!-- Video Section -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-4 text-gray-800 dark:text-gray-100">{{ video.title }}</h1>
            <!-- Embedded Video -->
            <div class="mb-6">
                <iframe class="w-full h-96 rounded-lg shadow-md"
                        src="https://www.youtube-nocookie.com/embed/{{ video.youtube_id }}"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        referrerpolicy="strict-origin-when-cross-origin">
                </iframe>
            </div>
            <!-- AI Summary Box -->
            {% if video.ai_summary %}
                <div class="bg-blue-50 dark:bg-blue-900 border-l-4 border-blue-500 p-6 rounded-lg mb-6">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-lightbulb text-blue-500 mt-1"></i>
                        <div>
                            <h3 class="font-semibold text-lg text-blue-900 dark:text-blue-100 mb-2">AI-Generated Summary</h3>
                            <p class="text-blue-800 dark:text-blue-200">{{ video.ai_summary }}</p>
                        </div>
                    </div>
                    {% if video.is_verified %}
                        <div class="mt-3 inline-block bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100 px-3 py-1 rounded-full text-sm font-medium">
                            <i class="fas fa-check-circle"></i> Verified Educational Content
                        </div>
                    {% endif %}
                </div>
            {% endif %}
            {% if video.description %}<p class="text-gray-700 dark:text-gray-300 mb-6">{{ video.description }}</p>{% endif %}
        </div>
        <!-- Quiz Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 mb-8">
            <h2 class="text-3xl font-bold mb-6 flex items-center gap-2 text-gray-800 dark:text-gray-100">
                <i class="fas fa-question-circle text-[#e74c3c]"></i> Knowledge Quiz
            </h2>
            {% if quiz_questions %}
                <form id="quizForm"
                      method="post"
                      action="{% url 'submit_quiz' video.id %}"
                      class="space-y-8">
                    {% csrf_token %}
                    <!-- Quiz Questions -->
                    {% for question in quiz_questions %}
                        <div class="quiz-question bg-gray-50 dark:bg-gray-700 p-6 rounded-lg border-l-4 border-[#e74c3c] transition-all"
                             data-question-id="{{ question.id }}">
                            <p class="font-semibold text-lg mb-4 text-gray-800 dark:text-gray-100">
                                <span class="inline-block bg-[#e74c3c] text-white w-8 h-8 rounded-full text-center leading-8 mr-3">{{ forloop.counter }}</span>
                                {{ question.question }}
                            </p>
                            <div class="space-y-3 ml-11">
                                {% for option, label in options %}
                                    <label class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition border border-gray-200 dark:border-gray-600">
                                        <input type="radio"
                                               name="question_{{ question.id }}"
                                               value="{{ label }}"
                                               class="w-5 h-5 text-[#e74c3c] cursor-pointer">
                                        <span class="ml-3 font-medium text-gray-700 dark:text-gray-300">{{ label }}. {{ option }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                    <!-- Submit Button -->
                    <button type="submit"
                            class="w-full px-6 py-3 bg-[#e74c3c] text-white font-semibold rounded-lg hover:bg-[#c0392b] transition flex items-center justify-center gap-2">
                        <i class="fas fa-check"></i> Submit Quiz
                    </button>
                </form>
                <!-- Results Modal (hidden by default) -->
                <div id="resultsModal"
                     class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 text-center animate-in fade-in zoom-in">
                        <div id="scoreCircle" class="mb-6 flex justify-center">
                            <div class="relative w-32 h-32">
                                <svg class="transform -rotate-90 w-32 h-32">
                                    <circle cx="64" cy="64" r="60" fill="none" stroke="#e0e0e0" stroke-width="8" />
                                    <circle id="progressCircle" cx="64" cy="64" r="60" fill="none" stroke="#e74c3c" stroke-width="8" stroke-dasharray="377" stroke-dashoffset="377" class="transition-all duration-1000" />
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span id="percentageText" class="text-3xl font-bold text-[#e74c3c]">0%</span>
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Score</span>
                                </div>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold mb-2 text-gray-800 dark:text-gray-100">
                            <span id="resultTitle"></span>
                        </h3>
                        <p id="resultMessage" class="text-gray-600 dark:text-gray-300 mb-6"></p>
                        <p class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">
                            <span id="scoreText"></span>
                        </p>
                        <div class="flex gap-3">
                            <button type="button"
                                    onclick="location.reload()"
                                    class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-100 font-semibold rounded-lg hover:bg-gray-400 dark:hover:bg-gray-700 transition">
                                Retake Quiz
                            </button>
                            <a href="{% url 'education' %}"
                               class="flex-1 px-4 py-2 bg-[#e74c3c] text-white font-semibold rounded-lg hover:bg-[#c0392b] transition">
                                Back to Videos
                            </a>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-8">
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Quiz is being generated by AI. Please check back in a few moments.</p>
                    <button onclick="location.reload()"
                            class="px-4 py-2 bg-[#e74c3c] text-white rounded-lg hover:bg-[#c0392b] transition">
                        Refresh Page
                    </button>
                </div>
            {% endif %}
        </div>
        <!-- Quiz History Section -->
        {% if user.is_authenticated and quiz_history %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
                <h3 class="text-2xl font-bold mb-4 flex items-center gap-2 text-gray-800 dark:text-gray-100">
                    <i class="fas fa-history text-[#e74c3c]"></i> Your Quiz History
                </h3>
                <div class="space-y-3">
                    {% for attempt in quiz_history %}
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 {% if attempt.percentage >= 70 %}border-green-500{% else %}border-yellow-500{% endif %}">
                            <div>
                                <p class="font-semibold text-gray-800 dark:text-gray-100">{{ attempt.get_date_display }}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Attempted {{ attempt.completed_at|date:"M d, Y H:i" }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold {% if attempt.percentage >= 70 %}text-green-600{% else %}text-yellow-600{% endif %}">
                                    {{ attempt.percentage|floatformat:1 }}%
                                </p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ attempt.score }}/{{ attempt.total_questions }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
    <style>
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.quiz-question {
    animation: slideIn 0.3s ease-out;
}

#resultsModal.show {
    display: flex;
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes zoomIn {
    from {
        transform: scale(0.95);
    }
    to {
        transform: scale(1);
    }
}
    </style>
    <script>
document.getElementById('quizForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('{% url "submit_quiz" video.id %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showResults(data.score, data.total, data.percentage);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while submitting the quiz.');
    }
});

function showResults(score, total, percentage) {
    const modal = document.getElementById('resultsModal');
    const resultTitle = document.getElementById('resultTitle');
    const resultMessage = document.getElementById('resultMessage');
    const scoreText = document.getElementById('scoreText');
    const percentageText = document.getElementById('percentageText');
    const progressCircle = document.getElementById('progressCircle');
    
    // Determine result message
    let title, message;
    if (percentage >= 90) {
        title = 'ðŸŽ‰ Excellent!';
        message = 'Outstanding performance! You have mastered this topic.';
    } else if (percentage >= 70) {
        title = 'ðŸ‘ Great Job!';
        message = 'Good understanding of the content. Well done!';
    } else if (percentage >= 50) {
        title = 'ðŸ“š Keep Learning!';
        message = 'You got the basics. Review the material and try again.';
    } else {
        title = 'ðŸ’ª Try Again!';
        message = 'Watch the video again and retake the quiz.';
    }
    
    resultTitle.textContent = title;
    resultMessage.textContent = message;
    scoreText.textContent = `You scored ${score} out of ${total} questions`;
    
    // Animate percentage and progress circle
    let currentPercentage = 0;
    const interval = setInterval(() => {
        if (currentPercentage <= percentage) {
            percentageText.textContent = Math.round(currentPercentage) + '%';
            const offset = 377 - (currentPercentage / 100) * 377;
            progressCircle.style.strokeDashoffset = offset;
            currentPercentage += percentage / 50;
        } else {
            clearInterval(interval);
        }
    }, 20);
    
    modal.classList.remove('hidden');
}
    </script>
{% endblock %}
