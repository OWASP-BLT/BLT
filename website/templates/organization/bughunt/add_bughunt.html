{% extends "organization/dashboard/organization_dashboard_base.html" %}
{% load static %}
{% block title %}
    Add Bug Bounty
{% endblock title %}
{% block description %}
    Create a new Bug Bounty and add prizes for the contest. Specify the domain, timeline, and upload related assets like logos and banners.
{% endblock description %}
{% block keywords %}
    Bug Bounty, Add Bug Bounty, Online Contest, Domain URL, Create Bug Bounty, Hunt Prizes
{% endblock keywords %}
{% block og_title %}
    Add Bug Bounty - Create a New Online Contest
{% endblock og_title %}
{% block og_description %}
    Set up a Bug Bounty contest, add prizes, and upload logos and banners to start the competition. Specify timelines and contest details.
{% endblock og_description %}
{% block body %}
    <div class="w-full bg-[#fdfeff]">
        <div class="max-w-[1700px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-[#e74c3c] font-satoshi font-bold text-[35px]">Add Bug Bounty</h1>
                <p class="text-gray-600 text-sm mt-2">
                    Create a new bug bounty program to engage security researchers and strengthen your application security.
                </p>
            </div>
            
            <!-- Form Container -->
            <form method='post'
                  action="{% url 'add_bughunt' organization %}"
                  id="add_bughunt_form"
                  enctype="multipart/form-data"
            {% csrf_token %}
            <div class="bg-white p-10 border border-gray-200 rounded-xl shadow-md ">
            <div class="pb-12">
                <h2 class="text-xl font-semibold text-gray-900">Bug Bounty Information</h2>
                <p class="mt-1 text-sm text-gray-600">Provide details about your bug bounty program and set the timeline for researchers.</p>
                <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                    <div class="sm:col-span-3">
                        <label for="bughunt_name"
                               class="block text-sm font-medium leading-6 text-gray-900">Bug Bounty Name</label>
                        <div class="mt-2">
                            <input type="text"
                                   name="bughunt_name"
                                   id="bughunt_name"
                                   autocomplete="bughunt_name"
                                   placeholder="Hunt 1.0"
                                   required
                                   class="block w-full rounded-md border-0 py-1.5 pl-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-red-600 sm:text-sm sm:leading-6" />
                        </div>
                    </div>
                    <div class="sm:col-span-3">
                        <label for="domain_url"
                               class="block text-sm font-medium leading-6 text-gray-900">Domain Url</label>
                        <div class="mt-2">
                            <input type="text"
                                   name="domain_url"
                                   id="domain_url"
                                   autocomplete="domain_url"
                                   placeholder="https://domain.xyz"
                                   required
                                   class="block w-full rounded-md border-0 py-1.5 pl-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-red-600 sm:text-sm sm:leading-6" />
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="domain"
                               class="block text-sm font-medium leading-6 text-gray-900">
                            Domain <span class="text-xs text-gray-500">(Select the domain for this bug bounty)</span>
                        </label>
                        <div class="mt-2 w-full">
                            <select id="domain"
                                    name="domain"
                                    autocomplete="domain-name"
                                    required
                                    class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 bg-white transition-colors duration-200 cursor-pointer sm:text-sm sm:leading-6">
                                <option value="" disabled selected>Select a domain</option>
                                {% for domain in domains %}<option value="{{ domain.id }}">{{ domain.name }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="start_date"
                               class="block text-sm font-medium leading-6 text-gray-900">Start Date</label>
                        <div class="mt-2">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-500"
                                         aria-hidden="true"
                                         xmlns="http://www.w3.org/2000/svg"
                                         fill="currentColor"
                                         viewBox="0 0 20 20">
                                        <path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z" />
                                    </svg>
                                </div>
                                <input name="start_date"
                                       required
                                       type="text"
                                       class="block w-full rounded-md border-0 py-1.5 pl-10 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-[#e74c3c] sm:text-sm sm:leading-6"
                                       placeholder="Select start date">
                            </div>
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="end_date"
                               class="block text-sm font-medium leading-6 text-gray-900">End Date</label>
                        <div class="mt-2">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-500"
                                         aria-hidden="true"
                                         xmlns="http://www.w3.org/2000/svg"
                                         fill="currentColor"
                                         viewBox="0 0 20 20">
                                        <path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z" />
                                    </svg>
                                </div>
                                <input name="end_date"
                                       required
                                       type="text"
                                       class="block w-full rounded-md border-0 py-1.5 pl-10 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-[#e74c3c] sm:text-sm sm:leading-6"
                                       placeholder="Select end date">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="space-y-12">
                <div class="border-b border-gray-900/10 pb-12 mt-10">
                    <h2 class="text-xl font-semibold text-gray-900">Bug Bounty Assets</h2>
                    <p class="mt-1 text-sm text-gray-600">Upload logo and banner images for your bug bounty program.</p>
                    
                    <div class="col-span-full mt-8">
                        <label for="logo" class="block text-sm font-medium leading-6 text-gray-900">Bug Bounty Logo</label>
                        <div class="mt-2 flex flex-col gap-4">
                            <div class="flex items-center gap-x-3">
                                <label for="logo" class="relative cursor-pointer">
                                    <div id="previewLogoDiv"
                                         class="relative h-32 w-32 overflow-hidden rounded-2xl border-2 border-dashed border-gray-300 hover:border-[#e74c3c] transition-colors duration-200">
                                        <img id="logoPreview"
                                             height="128"
                                             width="128"
                                             class="absolute inset-0 h-full w-full object-cover hidden rounded-2xl"
                                             alt="Logo preview" />
                                        <div id="defaultLogoIcon"
                                             class="absolute inset-0 flex items-center justify-center text-[#e74c3c]">
                                            <svg class="h-16 w-16"
                                                 viewBox="0 0 24 24"
                                                 fill="currentColor"
                                                 aria-hidden="true">
                                                <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                    </div>
                                    <input id="logo"
                                           name="logo"
                                           type="file"
                                           accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                                           class="sr-only"
                                           onchange="previewUploadedImage(this, 'logoPreview', 'defaultLogoIcon', 'removeLogo')" />
                                </label>
                                <div class="flex flex-col gap-2">
                                    <button type="button"
                                            id="removeLogo"
                                            onclick="removeUploadedImage('logo', 'logoPreview', 'defaultLogoIcon', 'removeLogo')"
                                            class="hidden text-sm text-[#e74c3c] hover:text-red-700 px-4 py-2 border border-[#e74c3c] rounded-md hover:bg-red-50 transition-colors duration-200">
                                        <span class="inline-flex items-center">
                                            <svg class="w-5 h-5 mr-2"
                                                 fill="none"
                                                 stroke="currentColor"
                                                 viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                            Remove
                                        </span>
                                    </button>
                                    <div id="logoError" class="hidden text-xs text-[#e74c3c] mt-1"></div>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Recommended: Square image, JPG/PNG/GIF, max 5MB, at least 128x128px</p>
                        </div>
                    </div>
                    <div class="col-span-full mt-8">
                        <label for="banner"
                               class="block text-sm font-medium leading-6 text-gray-900">Bug Bounty Banner</label>
                        <label for="banner" class="cursor-pointer block">
                            <div class="mt-2 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10 text-[#e74c3c] hover:border-[#e74c3c] transition-colors duration-200">
                                <div class="text-center">
                                    <svg class="mx-auto h-12 w-12"
                                         viewBox="0 0 24 24"
                                         fill="currentColor"
                                         aria-hidden="true">
                                        <path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z" clip-rule="evenodd" />
                                    </svg>
                                    <div class="mt-4 flex text-sm leading-6 text-gray-600 justify-center">
                                        <span class="font-semibold text-[#e74c3c]">Upload a banner</span>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs leading-5 text-gray-600">PNG, JPG, GIF up to 10MB</p>
                                </div>
                            </div>
                            <input id="banner"
                                   name="banner"
                                   type="file"
                                   accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                                   class="sr-only"
                                   onchange="displayBannerPreview()" />
                        </label>
                        <div id="bannerPreview" class="mt-4"></div>
                    </div>
                </div>
            </div>
            <div class="border-b border-gray-900/10 pb-12 mt-10">
                <h2 class="text-xl font-semibold text-gray-900">Bug Bounty Description</h2>
                <p class="mt-1 text-sm text-gray-600">Provide a detailed description of your bug bounty program, scope, and rules.</p>
                <div class="mt-6">
                    {% include "organization/organization_includes/md_editor.html" %}
                </div>
            </div>
            
            <div class="border-b border-gray-900/10 pb-12 mt-10">
                <h2 class="text-xl font-semibold text-gray-900">Bug Bounty Prizes</h2>
                <p class="mt-1 text-sm text-gray-600">Define the prizes and rewards for security researchers who find valid vulnerabilities.</p>
                    <div class="bg-gray-50 w-full p-7 mt-6 rounded-lg">
                        <p class="text-sm text-gray-600 mb-4">
                            Fill in the prize details below and click "Add Prize" to add it to your bug bounty program.
                        </p>
                        <div>
                            <label for="prize_name" class="font-bold">
                                <span class="text-red-500 mr-1">*</span>Prize Name
                            </label>
                            <input type="text"
                                   name="prize_name"
                                   id="prize_name"
                                   placeholder="1st Prize"
                                   class="w-full mt-2 px-2 py-2 mb-2 border-[1px] border-gray-200 outline-none">
                        </div>
                        <div class="mt-3">
                            <label for="cash_value" class="font-bold">
                                <span class="text-red-500 mr-1">*</span>Cash Value (USD)
                            </label>
                            <input type="number"
                                   min="0"
                                   placeholder="1000"
                                   name="cash_value"
                                   id="cash_value"
                                   class="w-full mt-2 px-2 py-2 mb-2 border-[1px] border-gray-200 outline-none">
                        </div>
                        <div class="mt-3">
                            <label for="number_of_winning_projects" class="font-bold">Number of Winning Projects</label>
                            <input type="number"
                                   min="1"
                                   placeholder="1 (Minimum)"
                                   id="number_of_winning_projects"
                                   name="number_of_winning_projects"
                                   class="w-full mt-2 px-2 py-2 mb-2 border-[1px] border-gray-200 outline-none">
                        </div>
                        <div class="mt-2 flex items-center">
                            <input type="checkbox"
                                   name="every_valid_submissions"
                                   id="every_valid_submissions"
                                   class="w-4 h-4">
                            <label for="every_valid_submissions" class="ml-2">
                                Every Valid Submissions are eligible for this prize (Cash Value Per Accepted Bug)
                            </label>
                        </div>
                        <div class="mt-3">
                            <label for="prize_description" class="font-bold">Prize Description</label>
                            <textarea type="text"
                                      name="prize_description"
                                      id="prize_description"
                                      class="w-full mt-2 px-2 py-2 mb-2 border-[1px] border-gray-200 outline-none"></textarea>
                        </div>
                        <div class="mt-3 flex flex-col" id="cryptocurrencyDiv">
                            <label class="font-bold">Will this prize will be paid in cryptocurrency?</label>
                            <p class="text-[12px] text-gray-700 ml-1">
                                Check below if your prize is paid in cryptocurrency, and list the cash value of the cryptocurrenty and specify the crypto name in Hunt description eg: $100 USD in ETH
                            </p>
                            <div class="mt-2 flex items-center">
                                <input type="checkbox"
                                       name="paid_in_cryptocurrency"
                                       id="paid_in_cryptocurrency"
                                       class="w-4 h-4">
                                <label for="paid_in_cryptocurrency" class="ml-2">The prize will be paid in cryptocurrency</label>
                            </div>
                        </div>
                        <button onclick="add_prize()"
                                type="button"
                                id="add_prize_button"
                                class="mt-8 bg-[#e74c3c] text-white font-semibold px-6 py-2.5 rounded-md hover:bg-red-700 transition-all duration-200">
                            Add Prize
                        </button>
                    </div>
                    <div class="sm:col-span-4 flex overflow-x-scroll"
                         id="list-prize-container">                    </div>
                </div>
                <!-- Action Buttons -->
            <div class=" py-6 ">
                <div class="flex items-center justify-end gap-x-6">
                    <button type="button"
                            onclick="cancelForm()"
                            class="text-md font-medium text-gray-600 hover:text-gray-900 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="button"
                            onclick="PublishBughunt('false')"
                            class="rounded-md bg-gray-600 px-12 py-2.5 text-md font-semibold text-white shadow-sm hover:bg-gray-700 transition-all duration-200">
                        Save as Draft
                    </button>
                    <button type="button"
                            onclick="PublishBughunt('true')"
                            class="rounded-md bg-[#e74c3c] px-12 py-2.5 text-md font-semibold text-white shadow-sm hover:bg-red-700 transition-all duration-200">
                        Publish
                    </button>
                </div>
            </div>
            </div>
            
            
            </form>
        </div>
    </div>
{% endblock body %}
{% block scripts %}
    <!-- Datepicker styles and scripts -->
    <style>
        /* Minimal datepicker styles to avoid header conflicts */
        [datepicker] { position: relative; }
        .datepicker { z-index: 50; }
        .datepicker-dropdown { background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.7.0/datepicker.min.js"></script>
    
    <!-- Hunt Controller Script -->
    <script src="{% static 'organization/js/hunt_controller.js' %}"></script>
    
    <script>
        // Initialize datepicker for proper date formatting
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.querySelector('input[name="start_date"]');
            const endDateInput = document.querySelector('input[name="end_date"]');
            
            if (startDateInput && endDateInput && typeof Datepicker !== 'undefined') {
                // Initialize Flowbite datepicker
                const startPicker = new Datepicker(startDateInput, {
                    format: 'mm/dd/yyyy',
                    autohide: true,
                    minDate: new Date()
                });
                
                const endPicker = new Datepicker(endDateInput, {
                    format: 'mm/dd/yyyy',
                    autohide: true,
                    minDate: new Date()
                });
            }
        });
        
        // Image preview functions from add domain page
        function previewUploadedImage(input, previewId, defaultIconId, removeButtonId) {
            const preview = document.getElementById(previewId);
            const defaultIcon = document.getElementById(defaultIconId);
            const removeButton = document.getElementById(removeButtonId);
            const errorDiv = document.getElementById('logoError');
            
            // Clear any previous errors
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }

            if (!preview || !defaultIcon || !removeButton) {
                console.error('One or more required elements not found');
                return;
            }

            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file type
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    if (errorDiv) {
                        errorDiv.textContent = 'Please select a valid image file (JPG, PNG, GIF, or WebP)';
                        errorDiv.style.display = 'block';
                    }
                    input.value = '';
                    return;
                }
                
                // Validate file size (5MB = 5 * 1024 * 1024 bytes)
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    if (errorDiv) {
                        errorDiv.textContent = 'File size must be less than 5MB';
                        errorDiv.style.display = 'block';
                    }
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Set the image source
                    preview.src = e.target.result;
                    
                    // Use style.display for more reliable showing/hiding
                    preview.style.display = 'block';
                    defaultIcon.style.display = 'none';
                    removeButton.style.display = 'inline-flex';
                    
                    // Also use classList as backup
                    preview.classList.remove('hidden');
                    defaultIcon.classList.add('hidden');
                    removeButton.classList.remove('hidden');
                }
                
                reader.onerror = function() {
                    console.error('Error reading file');
                    if (errorDiv) {
                        errorDiv.textContent = 'Error reading the file. Please try again.';
                        errorDiv.style.display = 'block';
                    }
                    input.value = '';
                }
                
                reader.readAsDataURL(file);
            }
        }

        function removeUploadedImage(inputId, previewId, defaultIconId, removeButtonId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const defaultIcon = document.getElementById(defaultIconId);
            const removeButton = document.getElementById(removeButtonId);
            const errorDiv = document.getElementById('logoError');

            if (!input || !preview || !defaultIcon || !removeButton) {
                console.error('One or more required elements not found');
                return;
            }
            
            // Clear the file input and preview
            input.value = '';
            preview.src = '';
            
            // Use style.display for more reliable showing/hiding
            preview.style.display = 'none';
            defaultIcon.style.display = 'flex';
            removeButton.style.display = 'none';
            
            // Also use classList as backup
            preview.classList.add('hidden');
            defaultIcon.classList.remove('hidden');
            removeButton.classList.add('hidden');
            
            // Clear any errors
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
        }
    </script>
{% endblock scripts %}
