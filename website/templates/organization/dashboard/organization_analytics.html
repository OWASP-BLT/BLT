{% extends "organization/dashboard/organization_dashboard_base.html" %}
{% load static %}
{% load custom_tags %}
{% block title %}
    Organization Analytics | {% env 'PROJECT_NAME' %}
{% endblock title %}
{% block body %}
    {% block edit_link %}
        <div class="bg-gray-50 dark:bg-gray-900 flex float-end gap-4 mr-10">
            <a class="text-black dark:text-white"
               href="https://github.com/OWASP-BLT/BLT/blob/main/website/templates/organization/organization_analytics.html">
                <i class="fab fa-github fa-2x"></i>
            </a>
            <a class="text-black dark:text-white"
               href="https://www.figma.com/file/s0xuxeU6O2guoWEfA9OElZ/Design?node-id=3%3A76&t=pqxWpF3hcYxjEDrs-1">
                <i class="fab fa-figma fa-2x"></i>
            </a>
        </div>
    {% endblock edit_link %}
    <div class="bg-gray-50 dark:bg-gray-900 pb-10 transition-colors">
        <div class="w-full">
            <p class="text-[#e74c3c] font-satoshi pt-5 font-bold text-[35px] px-8">Dashboard</p>
        </div>
        <div class="flex flex-col lg:flex-row gap-5 justify-center lg:justify-between w-full gap-y-4 px-8 mt-4 items-center">
            <div class="flex justify-center items-center bg-white shadow-md dark:bg-gray-800 w-[340px] h-[172px] rounded-xl hover:scale-105 transition-all">
                <div class="flex justify-evenly items-center w-[100%] h-[70%]">
                    <div class="flex justify-center items-center w-[90px] h-[90px] bg-red-200 rounded-[50px]">
                        <i class="fa-solid fa-bug fa-2x text-black dark:text-white"></i>
                    </div>
                    <div>
                        <a href="{% url 'organization_manage_bugs' organization %}">
                            <p class="text-black dark:text-white text-3xl font-bold">{{ total_info.total_organization_bugs }}</p>
                            <p class="text-black dark:text-white text-md font-extralight">Total Bugs</p>
                        </a>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap justify-center items-center bg-white shadow-md dark:bg-gray-800 w-[340px] h-[172px] rounded-xl hover:scale-105  transition-all">
                <div class="flex justify-evenly items-center w-[100%] h-[70%]">
                    <div class="flex justify-center items-center w-[90px] h-[90px] bg-red-200 rounded-[50px]">
                        <i class="fa-sharp fa-solid fa-flag fa-2x text-black dark:text-white"></i>
                    </div>
                    <div>
                        <a href="{% url 'organization_manage_bughunts' organization %}">
                            <p class="text-black dark:text-white text-3xl font-bold">{{ total_info.total_bug_hunts }}</p>
                            <p class="text-black dark:text-white text-md font-extralight">Bug Bounties</p>
                        </a>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap justify-center items-center bg-white shadow-md dark:bg-gray-800 w-[340px] h-[172px] rounded-xl hover:scale-105 transition-all">
                <div class="flex justify-evenly items-center w-[100%] h-[70%]">
                    <div class="flex justify-center items-center w-[90px] h-[90px] bg-red-200 rounded-[50px]">
                        <i class="fa-sharp fa-solid fa-globe fa-2x text-black dark:text-white"></i>
                    </div>
                    <div>
                        <a href="{% url 'organization_manage_domains' organization %}">
                            <p class="text-black dark:text-white text-3xl font-bold">{{ total_info.total_domains }}</p>
                            <p class="text-black dark:text-white text-md font-extralight">Domains</p>
                        </a>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap justify-center items-center bg-white shadow-md dark:bg-gray-800 w-[340px] h-[172px] rounded-xl hover:scale-105 transition-all">
                <div class="flex justify-evenly items-center w-[100%] h-[70%]">
                    <div class="flex justify-center items-center w-[90px] h-[90px] bg-red-200 rounded-[50px]">
                        <i class="fa-sharp fa-solid fa-dollar-sign fa-2x text-black dark:text-white"></i>
                    </div>
                    <div>
                        <p class="text-black dark:text-white text-3xl font-bold">$ {{ total_info.total_money_distributed }}</p>
                        <p class="text-black dark:text-white text-md font-extralight">Money Distributed</p>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap justify-center items-center bg-white shadow-md dark:bg-gray-800 w-[340px] h-[172px] rounded-xl hover:scale-105 transition-all">
                <div class="flex justify-evenly items-center w-[100%] h-[70%]">
                    <div class="flex justify-center items-center w-[90px] h-[90px] bg-red-200 rounded-[50px]">
                        <i class="fa-solid fa-shield-halved fa-2x text-black dark:text-white"></i>
                    </div>
                    <div>
                        <a href="#security-incidents">
                            <p class="text-black dark:text-white text-3xl font-bold">{{ security_incidents_summary.total_security_issues }}</p>
                            <p class="text-black dark:text-white text-md font-extralight">Security Issues</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex flex-col lg:flex-row gap-y-5 mt-4">
            <div class="flex flex-col ps-8 gap-5">
                <div class="flex flex-col lg:flex-row gap-5 bg-gray-50 dark:bg-gray-900">
                    <div class="bg-[#f6f6f6] shadow-sm dark:bg-gray-800 p-5 rounded-xl lg:w-[56vh]">
                        <div class="header-container">
                            <h3 class="section-header text-gray-900 dark:text-gray-100 text-lg font-semibold mb-4">Bug Reported Type</h3>
                        </div>
                        <div class="pie-chart w-full h-[90%]">
                            <canvas id="bugTypePie" height="220px" width="660px"></canvas>
                        </div>
                    </div>
                    <div class="bg-[#f6f6f6] shadow-sm dark:bg-gray-800 p-5 rounded-xl lg:w-[56vh]">
                        <div class="header-container">
                            <h3 class="section-header text-gray-900 dark:text-gray-100 text-lg font-semibold mb-4">Reported on Domains</h3>
                        </div>
                        <div class="pie-chart w-full h-[90%]">
                            <canvas id="domainPie" height="220px" width="660px"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-[#f6f6f6] shadow-sm dark:bg-gray-800 p-5 rounded-xl w-full lg:w-[115vh]">
                    <h3 class="section-header text-gray-900 dark:text-gray-100 text-lg font-semibold mb-4">
                        Monthly Reports of {{ get_current_year_monthly_reported_bar_data.current_year }}
                    </h3>
                    <div class="bar-chart">
                        <canvas id="myChart" height="220px" width="660px"></canvas>
                    </div>
                </div>
                <div class="p-5 bg-[#f6f6f6] shadow-sm dark:bg-gray-800 rounded-xl flex lg:flex-row lg:w-[115vh]">
                    <div class="w-full">
                        <div class="header-container">
                            <h3 class="section-header text-gray-900 dark:text-gray-100 text-lg font-semibold mb-4">Total Reported</h3>
                            {% if bug_rate_increase_descrease_weekly.is_increasing %}
                                <svg class="up-arrow"
                                     width="42"
                                     height="42"
                                     viewBox="0 0 42 42"
                                     fill="none"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <rect width="42" height="42" rx="8" fill="#F6F7F9" />
                                    <path d="M27.0702 18.57L21.0002 12.5L14.9302 18.57" stroke="#7FB519" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M21 29.5V12.67" stroke="#7FB519" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            {% else %}
                                <svg width="42"
                                     height="42"
                                     viewBox="0 0 42 42"
                                     fill="none"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <rect width="42" height="42" rx="8" fill="#F6F7F9" />
                                    <path d="M27.0702 23.43L21.0002 29.5L14.9302 23.43" stroke="#FF4423" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M21 12.5V29.33" stroke="#FF4423" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            {% endif %}
                        </div>
                        <h1 class="price text-3xl font-bold text-gray-900 dark:text-gray-100">
                            {{ bug_rate_increase_descrease_weekly.this_week_issue_count }}<span class="price-currency text-lg text-gray-600 dark:text-gray-400 ml-2">Bugs</span>
                        </h1>
                        <p class="text-gray-700 dark:text-gray-300">
                            <span class="{% if bug_rate_increase_descrease_weekly.is_increasing %}percentage-increase text-green-600 dark:text-green-400 font-semibold{% else %}percentage-decrease text-red-600 dark:text-red-400 font-semibold{% endif %}">
                                {{ bug_rate_increase_descrease_weekly.percent_increase }}%
                            </span>
                            {% if bug_rate_increase_descrease_weekly.is_increasing %}
                                Increasing
                            {% else %}
                                Decreasing
                            {% endif %}
                            compared to last week
                        </p>
                    </div>
                    <div class="w-full">
                        <div class="header-container">
                            <h3 class="section-header text-gray-900 dark:text-gray-100 text-lg font-semibold mb-4">Accepted Bugs</h3>
                            {% if accepted_bug_rate_increase_descrease_weekly.is_increasing %}
                                <svg class="up-arrow"
                                     width="42"
                                     height="42"
                                     viewBox="0 0 42 42"
                                     fill="none"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <rect width="42" height="42" rx="8" fill="#F6F7F9" />
                                    <path d="M27.0702 18.57L21.0002 12.5L14.9302 18.57" stroke="#7FB519" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M21 29.5V12.67" stroke="#7FB519" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            {% else %}
                                <svg width="42"
                                     height="42"
                                     viewBox="0 0 42 42"
                                     fill="none"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <rect width="42" height="42" rx="8" fill="#F6F7F9" />
                                    <path d="M27.0702 23.43L21.0002 29.5L14.9302 23.43" stroke="#FF4423" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M21 12.5V29.33" stroke="#FF4423" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            {% endif %}
                        </div>
                        <h1 class="price text-3xl font-bold text-gray-900 dark:text-gray-100">
                            {{ accepted_bug_rate_increase_descrease_weekly.this_week_issue_count }}<span class="price-currency text-lg text-gray-600 dark:text-gray-400 ml-2">Accepted
                        Bugs</span>
                    </h1>
                    <p class="text-gray-700 dark:text-gray-300">
                        <span class="{% if accepted_bug_rate_increase_descrease_weekly.is_increasing %}percentage-increase text-green-600 dark:text-green-400 font-semibold{% else %}percentage-decrease text-red-600 dark:text-red-400 font-semibold{% endif %}">
                            {{ accepted_bug_rate_increase_descrease_weekly.percent_increase }}%
                        </span>
                        {% if accepted_bug_rate_increase_descrease_weekly.is_increasing %}
                            Increasing
                        {% else %}
                            Decreasing
                        {% endif %}
                        compared to last week
                    </p>
                </div>
            </div>
        </div>
        <div class="mx-5 flex flex-col gap-5 lg:w-[60vh]">
            <div class="rounded-xl bg-[#f6f6f6] shadow-sm dark:bg-gray-800 p-5">
                <div class="header-container flex justify-between">
                    <h3 class="section-header text-gray-900 dark:text-gray-100 text-lg font-semibold mb-4">Your balance</h3>
                    <svg width="24"
                         height="25"
                         viewBox="0 0 24 25"
                         fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 10.4166C3.9 10.4166 3 11.3541 3 12.5C3 13.6458 3.9 14.5833 5 14.5833C6.1 14.5833 7 13.6458 7 12.5C7 11.3541 6.1 10.4166 5 10.4166Z" stroke="#1A202C" stroke-width="1.5" />
                        <path d="M19 10.4166C17.9 10.4166 17 11.3541 17 12.5C17 13.6458 17.9 14.5833 19 14.5833C20.1 14.5833 21 13.6458 21 12.5C21 11.3541 20.1 10.4166 19 10.4166Z" stroke="#1A202C" stroke-width="1.5" />
                        <path d="M12 10.4166C10.9 10.4166 10 11.3541 10 12.5C10 13.6458 10.9 14.5833 12 14.5833C13.1 14.5833 14 13.6458 14 12.5C14 11.3541 13.1 10.4166 12 10.4166Z" stroke="#1A202C" stroke-width="1.5" />
                    </svg>
                </div>
                <h1 class="price text-3xl font-bold text-gray-900 dark:text-gray-100">
                    $120,435.00<span class="price-currency text-lg text-gray-600 dark:text-gray-400 ml-2">(USD)</span>
                </h1>
                <p class="text-gray-600 dark:text-gray-400 mb-4">From Jan 01, 2022 to Jan 31, 2022</p>
                <div class="button-box">
                    <button class="btn btn-purple">
                        <svg width="23"
                             height="23"
                             viewBox="0 0 23 23"
                             fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M9.104 13.1771C9.104 14.1066 9.82277 14.8541 10.7044 14.8541H12.5061C13.2727 14.8541 13.8957 14.2025 13.8957 13.3879C13.8957 12.5158 13.5123 12.1996 12.9469 11.9983L10.0623 10.9921C9.49692 10.7908 9.1136 10.4841 9.1136 9.60248C9.1136 8.79748 9.7365 8.13623 10.5032 8.13623H12.3048C13.1865 8.13623 13.9053 8.88373 13.9053 9.81331" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M11.5 7.1875V15.8125" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M21.0832 11.5C21.0832 16.79 16.7898 21.0833 11.4998 21.0833C6.20984 21.0833 1.9165 16.79 1.9165 11.5C1.9165 6.20996 6.20984 1.91663 11.4998 1.91663" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M16.2915 2.875V6.70833H20.1248" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M21.0832 1.91663L16.2915 6.70829" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span>Top Up</span>
                    </button>
                    <button class="btn btn-white">
                        <svg width="23"
                             height="23"
                             viewBox="0 0 23 23"
                             fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M9.104 13.1771C9.104 14.1066 9.82277 14.8541 10.7044 14.8541H12.5061C13.2727 14.8541 13.8957 14.2025 13.8957 13.3879C13.8957 12.5158 13.5123 12.1996 12.9469 11.9983L10.0623 10.9921C9.49692 10.7908 9.1136 10.4841 9.1136 9.60248C9.1136 8.79748 9.7365 8.13623 10.5032 8.13623H12.3048C13.1865 8.13623 13.9053 8.88373 13.9053 9.81331" stroke="#1A202C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M11.5 7.1875V15.8125" stroke="#1A202C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M21.0832 11.5C21.0832 16.79 16.7898 21.0833 11.4998 21.0833C6.20984 21.0833 1.9165 16.79 1.9165 11.5C1.9165 6.20996 6.20984 1.91663 11.4998 1.91663" stroke="#1A202C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M21.0833 5.74996V1.91663H17.25" stroke="#1A202C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M16.2915 6.70829L21.0832 1.91663" stroke="#1A202C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span>Transfer</span>
                    </button>
                </div>
            </div>
            <div class="box spending-box bg-[#f6f6f6] dark:bg-gray-800 p-5 rounded-xl shadow-sm">
                <div class="header-container flex justify-between">
                    <h3 class="section-header text-gray-900 dark:text-gray-100 text-lg font-semibold mb-4">Spent On Bug Types</h3>
                    <svg width="24"
                         height="25"
                         viewBox="0 0 24 25"
                         fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 10.4166C3.9 10.4166 3 11.3541 3 12.5C3 13.6458 3.9 14.5833 5 14.5833C6.1 14.5833 7 13.6458 7 12.5C7 11.3541 6.1 10.4166 5 10.4166Z" stroke="#1A202C" stroke-width="1.5" />
                        <path d="M19 10.4166C17.9 10.4166 17 11.3541 17 12.5C17 13.6458 17.9 14.5833 19 14.5833C20.1 14.5833 21 13.6458 21 12.5C21 11.3541 20.1 10.4166 19 10.4166Z" stroke="#1A202C" stroke-width="1.5" />
                        <path d="M12 10.4166C10.9 10.4166 10 11.3541 10 12.5C10 13.6458 10.9 14.5833 12 14.5833C13.1 14.5833 14 13.6458 14 12.5C14 11.3541 13.1 10.4166 12 10.4166Z" stroke="#1A202C" stroke-width="1.5" />
                    </svg>
                </div>
                <div class="pie-chart">
                    <canvas id="spentOnBugTypes" height="220px" width="220px"></canvas>
                </div>
                <div class="overall-spending mb-4">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Total Spent</h4>
                    <span class="text-2xl font-bold text-gray-900 dark:text-gray-100">${{ total_info.total_money_distributed }}</span>
                </div>
                <div class="pie-chart__labels">
                    {% for bugtype, money_spent in spent_on_bugtypes.zipped_data %}
                        <div class="pie-chart__labels-item flex gap-1 dark:text-white">
                            <div class="label">
                                <div class="label__color first"></div>
                                {{ bugtype }} :
                            </div>
                            ${{ money_spent }}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <!-- Security Incidents Summary Section -->
    <div id="security-incidents" class="w-full px-8 mt-8">
        <div class="bg-[#f6f6f6] dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Security Incidents Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Recent Incidents -->
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Recent Incidents (30 days)</h3>
                    <p class="text-3xl font-bold text-red-600">{{ security_incidents_summary.recent_incidents }}</p>
                </div>
                <!-- Average Resolution Time -->
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Avg Resolution Time</h3>
                    <p class="text-3xl font-bold text-gray-700 dark:text-gray-300">
                        {% if security_incidents_summary.avg_resolution_time %}
                            {{ security_incidents_summary.avg_resolution_time|timesince }}
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                </div>
                <!-- Severity Distribution -->
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Severity Distribution</h3>
                    <div class="space-y-2">
                        {% for severity in security_incidents_summary.severity_distribution %}
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">Level {{ severity.severity }}</span>
                                <span class="font-semibold">{{ severity.count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- Top Affected Domains -->
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg md:col-span-2 lg:col-span-3">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Top Affected Domains</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for domain in security_incidents_summary.top_affected_domains %}
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-md shadow-sm">
                                <p class="font-medium text-gray-800 dark:text-gray-200">{{ domain.domain__name }}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ domain.count }} incidents</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Threat Intelligence Section -->
    <div id="threat-intelligence" class="w-full px-8 mt-8">
        <div class="bg-[#f6f6f6] dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Threat Intelligence</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Risk Score -->
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Security Risk Score</h3>
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                            <div>
                                <span class="text-3xl font-bold inline-block py-1 px-2 rounded-full {% if threat_intelligence.risk_score >= 75 %}text-[#e74c3c] {% elif threat_intelligence.risk_score >= 50 %}text-yellow-600 {% else %}text-green-600{% endif %}">
                                    {{ threat_intelligence.risk_score }}/100
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Top Attack Vectors -->
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Top Issue Categories</h3>
                    <div class="space-y-2">
                        {% for vector in threat_intelligence.attack_vectors %}
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-400">{{ vector.vulnerability_type }}</span>
                                <span class="font-semibold">{{ vector.count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- Recent Security Alerts -->
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Recent Security Alerts</h3>
                    <div class="space-y-3">
                        {% for alert in threat_intelligence.recent_alerts %}
                            <div class="flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full {% if alert.cve_score >= 8 %}bg-red-500{% elif alert.cve_score >= 5 %}bg-yellow-500{% else %}bg-orange-500{% endif %}"></span>
                                <span class="text-sm text-gray-600 dark:text-gray-400 truncate">{{ alert.description }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Network Traffic Analysis Section -->
    <div id="network-traffic" class="w-full px-8 mt-8">
        <div class="bg-[#f6f6f6] dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Network Traffic Analysis</h2>
            <!-- Traffic Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg flex flex-col items-center justify-center">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Daily Traffic</h3>
                    <div class="flex justify-center items-center w-[90px] h-[90px] bg-blue-200 dark:bg-blue-800 rounded-[50px] mb-2">
                        <i class="fa-solid fa-chart-line fa-2x text-gray-800 dark:text-gray-200"></i>
                    </div>
                    <p class="text-3xl font-bold text-gray-700 dark:text-gray-300">{{ network_traffic_data.day_count }}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Last 24 hours</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg flex flex-col items-center justify-center">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Weekly Traffic</h3>
                    <div class="flex justify-center items-center w-[90px] h-[90px] bg-purple-200 dark:bg-purple-800 rounded-[50px] mb-2">
                        <i class="fa-solid fa-calendar-week fa-2x text-gray-800 dark:text-gray-200"></i>
                    </div>
                    <p class="text-3xl font-bold text-gray-700 dark:text-gray-300">{{ network_traffic_data.week_count }}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Last 7 days</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg flex flex-col items-center justify-center">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Peak Hour</h3>
                    <div class="flex justify-center items-center w-[90px] h-[90px] bg-yellow-200 dark:bg-yellow-700 rounded-[50px] mb-2">
                        <i class="fa-solid fa-bolt fa-2x text-gray-800 dark:text-gray-200"></i>
                    </div>
                    <p class="text-3xl font-bold text-gray-700 dark:text-gray-300">{{ network_traffic_data.peak_hour }}:00</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">{{ network_traffic_data.peak_count }} requests</p>
                </div>
            </div>
            <!-- Traffic Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="header-container mb-4">
                        <h3 class="section-header text-lg font-semibold text-gray-900 dark:text-gray-100">Daily Traffic Volume (30 Days)</h3>
                    </div>
                    <div class="relative h-[300px]">
                        <canvas id="trafficVolumeChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="header-container mb-4">
                        <h3 class="section-header text-lg font-semibold text-gray-900 dark:text-gray-100">Hourly Distribution</h3>
                    </div>
                    <div class="relative h-[300px]">
                        <canvas id="hourlyDistributionChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- Domain Error Rates -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Top Domains with Errors</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="py-3 px-4 text-left text-gray-900 dark:text-gray-100">Domain</th>
                                <th class="py-3 px-4 text-left text-gray-900 dark:text-gray-100">Error Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for domain in network_traffic_data.domain_error_rates %}
                                <tr class="border-t border-gray-200 dark:border-gray-600">
                                    <td class="py-3 px-4 text-gray-800 dark:text-gray-200">{{ domain.domain__name }}</td>
                                    <td class="py-3 px-4 text-gray-800 dark:text-gray-200">{{ domain.error_count }}</td>
                                </tr>
                            {% empty %}
                                <tr class="border-t border-gray-200 dark:border-gray-600">
                                    <td class="py-3 px-4 text-center text-gray-500 dark:text-gray-400"
                                        colspan="2">No domain error data available</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Compliance Monitoring Section -->
    <div id="compliance-monitoring" class="w-full px-8 mt-8 pb-8">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Compliance Monitoring</h2>
            <!-- Overall Compliance Score -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Overall Compliance</h3>
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                            <div>
                                <span class="text-3xl font-bold inline-block py-1 px-2 rounded-full {% if compliance_monitoring.overall_compliance >= 80 %}text-green-600{% elif compliance_monitoring.overall_compliance >= 60 %}text-yellow-600{% else %}text-[#e74c3c]{% endif %}">
                                    {{ compliance_monitoring.overall_compliance }}%
                                </span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200">
                            <div style="width:{{ compliance_monitoring.overall_compliance }}%"
                                 class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center {% if compliance_monitoring.overall_compliance >= 80 %}bg-green-500{% elif compliance_monitoring.overall_compliance >= 60 %}bg-yellow-500{% else %}bg-[#e74c3c]{% endif %}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Security.txt Compliance</h3>
                    <p class="text-3xl font-bold text-gray-700 dark:text-gray-300">{{ compliance_monitoring.security_txt_compliance }}%</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                        {{ compliance_monitoring.domains_with_security_txt }}/{{ compliance_monitoring.total_domains }} domains
                    </p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Resolution Compliance</h3>
                    <p class="text-3xl font-bold text-gray-700 dark:text-gray-300">{{ compliance_monitoring.resolution_compliance }}%</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                        {{ compliance_monitoring.compliant_resolutions }}/{{ compliance_monitoring.total_resolved }} within SLA
                    </p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Overdue Security Issues</h3>
                    <p class="text-3xl font-bold {% if compliance_monitoring.overdue_security_issues > 5 %}text-[#e74c3c]{% elif compliance_monitoring.overdue_security_issues > 0 %}text-yellow-600{% else %}text-green-600{% endif %}">
                        {{ compliance_monitoring.overdue_security_issues }}
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                        {{ compliance_monitoring.total_security_issues }} total security issues
                    </p>
                </div>
            </div>
            <!-- Compliance Trend Chart -->
            <div class="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 mb-6">
                <div class="header-container mb-4">
                    <h3 class="section-header text-lg font-semibold">Compliance Trend (6 Months)</h3>
                </div>
                <div class="relative h-[300px]">
                    <canvas id="complianceTrendChart"></canvas>
                </div>
            </div>
            <!-- Domain Compliance Status -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Domain Compliance Status</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white dark:bg-gray-900 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 dark:bg-gray-800">
                            <tr>
                                <th class="py-3 px-4 text-left">Domain</th>
                                <th class="py-3 px-4 text-left">Security.txt</th>
                                <th class="py-3 px-4 text-left">Overdue Issues</th>
                                <th class="py-3 px-4 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for domain in compliance_monitoring.domain_compliance %}
                                <tr class="border-t border-gray-200 dark:border-gray-700">
                                    <td class="py-3 px-4">{{ domain.name }}</td>
                                    <td class="py-3 px-4">
                                        {% if domain.has_security_txt %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-check mr-1"></i> Yes
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                <i class="fas fa-times mr-1"></i> No
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="py-3 px-4">{{ domain.overdue_issues }}</td>
                                    <td class="py-3 px-4">
                                        {% if domain.status == "compliant" %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-check-circle mr-1"></i> Compliant
                                            </span>
                                        {% elif domain.status == "warning" %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                <i class="fas fa-exclamation-triangle mr-1"></i> Warning
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                <i class="fas fa-times-circle mr-1"></i> Critical
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr class="border-t border-gray-200 dark:border-gray-700">
                                    <td class="py-3 px-4 text-center" colspan="4">No domain compliance data available</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock body %}
{% block js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.2.1/chart.min.js"
            integrity="sha384-+94tm/qgImqyuSRr1vU2PjQIoot8h3qdaFB/xTawzWLRkcCWPricrBj5Xr45hCP1"
            crossorigin="anonymous"></script>
    <script src="{% static 'organization/js/index.js' %}"></script>
    <script src="{% static 'js/darkMode.js' %}"></script>
    <script>
  // populate Chart (PIE): Bug Report  Type
  function populateBugTypePie() {
    var bugTypePie = document.getElementById("bugTypePie").getContext("2d");

    // Create the pie chart
    new Chart(bugTypePie, {
      type: "pie",
      data: {
        labels: JSON.parse(
          '{{ bug_report_type_piechart_data.bug_report_type_labels | safe }}'
        ),
        datasets: [
          {
            label: "Pie Chart",
            data: JSON.parse(
              '{{ bug_report_type_piechart_data.bug_report_type_data | safe }}'
            ),
            backgroundColor: [
              "rgb(255, 99, 132)",
              "rgb(54, 162, 235)",
              "rgb(255, 205, 86)",
            ],
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
      },
    });
  }

  function populateReportOnDomainsPie() {
    var domainPie = document.getElementById("domainPie").getContext("2d");

    // Create the pie chart
    new Chart(domainPie, {
      type: "pie",
      data: {
        labels: JSON.parse(
          '{{ reports_on_domain_piechart_data.bug_report_on_domains_labels | safe }}'
        ),
        datasets: [
          {
            label: "Pie Chart",
            data: JSON.parse(
              '{{ reports_on_domain_piechart_data.bug_report_on_domains_data | safe }}'
            ),
            backgroundColor: [
              "rgb(255, 99, 132)",
              "rgb(54, 162, 235)",
              "rgb(255, 205, 86)",
            ],
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
      },
    });
  }

  function populateMonthlyReportBarChart() {
    const ctx = document.getElementById("myChart");

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: JSON.parse(
          '{{ get_current_year_monthly_reported_bar_data.bug_monthly_report_labels | safe }}'
        ),
        datasets: [
          {
            label: "Expense",
            data: JSON.parse(
              '{{ get_current_year_monthly_reported_bar_data.bug_monthly_report_data | safe }}'
            ),
            borderWidth: 1,
            borderRadius: 30,
            barThickness: 12,
            backgroundColor: ["rgba(114, 92, 255, 1)"],
            borderColor: ["rgba(114, 92, 255, 1)"],
            hoverBackgroundColor: ["rgba(28, 30, 35, 1)"],
            hoverBorderColor: ["rgba(28, 30, 35, 1)"],
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              // Include a dollar sign in the ticks
              callback: function (value, index, ticks) {
                return value + " Bugs";
              },
              stepSize: JSON.parse(
                '{{ get_current_year_monthly_reported_bar_data.max_count | safe }}'
              ),
            },
          },
          x: {
            grid: {
              display: false,
            },
          },
        },
        plugins: {
          legend: {
            display: false,
            labels: {
              font: {
                size: 12,
                family: "'Plus Jakarta Sans', sans-serif",
                lineHeight: 18,
                weight: 600,
              },
            },
          },
        },
      },
    });
  }

  function populateSpentOnBugTypes() {
    const ctx2 = document.getElementById("spentOnBugTypes");

    new Chart(ctx2, {
      type: "doughnut",
      data: {
        labels: JSON.parse('{{ spent_on_bugtypes.labels | safe }}'),
        datasets: [
          {
            data: JSON.parse('{{ spent_on_bugtypes.data | safe }}'),
            borderRadius: 5,
            cutout: 80,
            backgroundColor: [
              "rgb(235, 124, 166)",
              "rgb(255, 172, 200)",
              "rgb(204, 111, 248)",
              "rgb(124, 92, 252)",
              "rgb(92, 175, 252)",
              "rgb(161, 169, 254)",
              "rgb(161, 169, 254)",
              "rgb(161, 169, 254)",
            ],
            hoverOffset: 4,
            spacing: 8,
          },
        ],
      },
      options: {
        plugins: {
          legend: {
            display: false,
          },
        },
      },
    });
  }

  populateSpentOnBugTypes();
  populateMonthlyReportBarChart();
  populateReportOnDomainsPie();
  populateBugTypePie();

  // Network Traffic Analysis Charts
  function populateTrafficVolumeChart() {
    const trafficCtx = document.getElementById("trafficVolumeChart").getContext("2d");

    // Use data from the backend
    const trafficData = {
      labels: JSON.parse('{{ network_traffic_data.traffic_dates|safe }}'),
      datasets: [{
        label: 'Requests',
        data: JSON.parse('{{ network_traffic_data.traffic_counts|safe }}'),
        borderColor: 'rgb(54, 162, 235)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    };

    new Chart(trafficCtx, {
      type: 'line',
      data: trafficData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of Requests'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Date'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y + ' requests';
              }
            }
          }
        }
      }
    });
  }

  function populateHourlyDistributionChart() {
    const hourlyCtx = document.getElementById("hourlyDistributionChart").getContext("2d");

    // Use data from the backend
    const hourlyData = {
      labels: JSON.parse('{{ network_traffic_data.hours|safe }}'),
      datasets: [{
        label: 'Requests by Hour',
        data: JSON.parse('{{ network_traffic_data.hourly_counts|safe }}'),
        backgroundColor: 'rgba(153, 102, 255, 0.2)',
        borderColor: 'rgb(153, 102, 255)',
        borderWidth: 1
      }]
    };

    new Chart(hourlyCtx, {
      type: 'bar',
      data: hourlyData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of Requests'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Hour of Day (24h format)'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y;
              }
            }
          }
        }
      }
    });
  }

  // Initialize network traffic charts
  populateTrafficVolumeChart();
  populateHourlyDistributionChart();

  // Compliance Trend Chart
  function populateComplianceTrendChart() {
    const complianceCtx = document.getElementById("complianceTrendChart").getContext("2d");

    const complianceData = {
      labels: JSON.parse('{{ compliance_monitoring.monthly_compliance_labels|safe }}'),
      datasets: [{
        label: 'Compliance Rate (%)',
        data: JSON.parse('{{ compliance_monitoring.monthly_compliance_data|safe }}'),
        backgroundColor: 'rgba(127, 181, 25, 0.2)',
        borderColor: 'rgb(127, 181, 25)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: 'rgb(127, 181, 25)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    };

    new Chart(complianceCtx, {
      type: 'line',
      data: complianceData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Compliance Rate (%)'
            },
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          },
          x: {
            title: {
              display: true,
              text: 'Month'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y + '%';
              }
            }
          },
          legend: {
            display: true,
            position: 'top'
          }
        }
      }
    });
  }

  // Initialize compliance monitoring chart
  populateComplianceTrendChart();
    </script>
{% endblock js %}
