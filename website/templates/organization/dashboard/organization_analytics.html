{% extends "organization/dashboard/organization_dashboard_base.html" %}
{% load static %}
{% load custom_tags %}
{% block title %}
    Organization Analytics | {% env 'PROJECT_NAME' %}
{% endblock title %}
{% block description %}
    View comprehensive analytics and insights for your organization. Track bugs, security incidents, and performance metrics in one place.
{% endblock description %}
{% block keywords %}
    Organization Analytics, Bug Tracking, Security Metrics, Performance Dashboard, Analytics Overview
{% endblock keywords %}
{% block og_title %}
    Organization Analytics - Data-Driven Security Insights
{% endblock og_title %}
{% block og_description %}
    Get a comprehensive view of your organization's security metrics, bug trends, and performance data with clear analytics and reporting.
{% endblock og_description %}
{% block body %}
    <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
        <!-- Header Section -->
        <div class="bg-white shadow-sm border-b border-gray-200">
            <div class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Analytics Dashboard</h1>
                        <p class="mt-1 text-sm text-gray-500">Track your organization's security metrics and performance</p>
                    </div>
                </div>
            </div>
                    </div>
        <!-- Main Content -->
        <div class="w-full mx-auto px-4 sm:px-6 lg:px-4 py-4">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Total Bugs Card -->
                <a href="{% url 'organization_manage_bugs' organization %}"
                   class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all duration-200">
                    <div class="flex items-center justify-between">
                    <div>
                            <p class="text-sm text-gray-500 mb-1">Total Bugs</p>
                            <p class="text-3xl font-bold text-gray-900">{{ total_info.total_organization_bugs }}</p>
                    </div>
                        <div class="w-12 h-12 bg-[#e74c3c]/10 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-bug text-[#e74c3c] text-xl"></i>
            </div>
                    </div>
                </a>
                <!-- Bug Bounties Card -->
                <a href="{% url 'organization_manage_bughunts' organization %}"
                   class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all duration-200">
                    <div class="flex items-center justify-between">
                    <div>
                            <p class="text-sm text-gray-500 mb-1">Bug Bounties</p>
                            <p class="text-3xl font-bold text-gray-900">{{ total_info.total_bug_hunts }}</p>
                    </div>
                        <div class="w-12 h-12 bg-[#e74c3c]/10 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-flag text-[#e74c3c] text-xl"></i>
            </div>
                    </div>
                </a>
                <!-- Domains Card -->
                <a href="{% url 'organization_manage_domains' organization %}"
                   class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all duration-200">
                    <div class="flex items-center justify-between">
                    <div>
                            <p class="text-sm text-gray-500 mb-1">Domains</p>
                            <p class="text-3xl font-bold text-gray-900">{{ total_info.total_domains }}</p>
                        </div>
                        <div class="w-12 h-12 bg-[#e74c3c]/10 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-globe text-[#e74c3c] text-xl"></i>
                        </div>
                    </div>
                </a>
                <!-- Money Distributed Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Money Distributed</p>
                            <p class="text-3xl font-bold text-gray-900">${{ total_info.total_money_distributed }}</p>
                        </div>
                        <div class="w-12 h-12 bg-[#e74c3c]/10 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-dollar-sign text-[#e74c3c] text-xl"></i>
                        </div>
                    </div>
                </div>
                    </div>
            <!-- Weekly Trends -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Total Reported Bugs Trend -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Total Reported This Week</h3>
                            {% if bug_rate_increase_descrease_weekly.is_increasing %}
                            <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                                <i class="fas fa-arrow-up mr-1"></i>
                                {{ bug_rate_increase_descrease_weekly.percent_increase }}%
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-semibold">
                                <i class="fas fa-arrow-down mr-1"></i>
                                {{ bug_rate_increase_descrease_weekly.percent_increase }}%
                            </span>
                            {% endif %}
                    </div>
                    <p class="text-4xl font-bold text-gray-900 mb-2">{{ bug_rate_increase_descrease_weekly.this_week_issue_count }}</p>
                    <p class="text-sm text-gray-500">
                        {% if bug_rate_increase_descrease_weekly.is_increasing %}Increasing{% else %}Decreasing{% endif %} compared to last week
                    </p>
                        </div>
                <!-- Accepted Bugs Trend -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Accepted Bugs This Week</h3>
                        {% if accepted_bug_rate_increase_descrease_weekly.is_increasing %}
                            <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                                <i class="fas fa-arrow-up mr-1"></i>
                                {{ accepted_bug_rate_increase_descrease_weekly.percent_increase }}%
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-semibold">
                                <i class="fas fa-arrow-down mr-1"></i>
                                {{ accepted_bug_rate_increase_descrease_weekly.percent_increase }}%
                            </span>
                        {% endif %}
                    </div>
                    <p class="text-4xl font-bold text-gray-900 mb-2">{{ accepted_bug_rate_increase_descrease_weekly.this_week_issue_count }}</p>
                    <p class="text-sm text-gray-500">
                        {% if accepted_bug_rate_increase_descrease_weekly.is_increasing %}Increasing{% else %}Decreasing{% endif %} compared to last week
                    </p>
                </div>
            </div>
            <!-- Security Incidents Summary -->
            <div id="security-incidents" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Security Incidents Summary</h2>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Recent Incidents (30 days)</p>
                            <p class="text-3xl font-bold text-gray-900">{{ security_incidents_summary.recent_incidents }}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Total Security Issues</p>
                            <p class="text-3xl font-bold text-gray-900">{{ security_incidents_summary.total_security_issues }}</p>
                        </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Avg Resolution Time</p>
                            <p class="text-2xl font-bold text-gray-900">
                        {% if security_incidents_summary.avg_resolution_time %}
                            {{ security_incidents_summary.avg_resolution_time|timesince }}
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                </div>
                    </div>
                    {% if security_incidents_summary.severity_distribution %}
                        <div class="mb-6">
                            <h3 class="text-sm font-semibold text-gray-700 mb-3">Severity Distribution</h3>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        {% for severity in security_incidents_summary.severity_distribution %}
                                    <div class="bg-gray-50 p-3 rounded-lg text-center">
                                        <p class="text-xs text-gray-600 mb-1">Level {{ severity.severity }}</p>
                                        <p class="text-2xl font-bold text-gray-900">{{ severity.count }}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                    {% endif %}
                    {% if security_incidents_summary.top_affected_domains %}
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-3">Top Affected Domains</h3>
                            <div class="space-y-2">
                        {% for domain in security_incidents_summary.top_affected_domains %}
                                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                        <span class="text-sm font-medium text-gray-900">{{ domain.domain__name }}</span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 bg-[#e74c3c]/10 text-[#e74c3c] rounded-full text-xs font-semibold">
                                            {{ domain.count }} incident{{ domain.count|pluralize }}
                                        </span>
                            </div>
                        {% endfor %}
                    </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Threat Intelligence -->
            <div id="threat-intelligence" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Threat Intelligence</h2>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Security Risk Score</p>
                            <p class="text-4xl font-bold {% if threat_intelligence.risk_score >= 75 %}text-red-600{% elif threat_intelligence.risk_score >= 50 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ threat_intelligence.risk_score }}<span class="text-2xl text-gray-400">/100</span>
                            </p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-3">Top Issue Categories</p>
                            <div class="space-y-2">
                                {% for vector in threat_intelligence.attack_vectors|slice:":3" %}
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-700">{{ vector.vulnerability_type|truncatechars:20 }}</span>
                                        <span class="font-semibold text-gray-900">{{ vector.count }}</span>
                                    </div>
                                {% endfor %}
        </div>
    </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-3">Recent Security Alerts</p>
                            <div class="space-y-2">
                                {% for alert in threat_intelligence.recent_alerts|slice:":3" %}
                                    <div class="flex items-start gap-2 text-sm">
                                        <span class="w-2 h-2 rounded-full mt-1.5 flex-shrink-0 {% if alert.cve_score >= 8 %}bg-red-500{% elif alert.cve_score >= 5 %}bg-yellow-500{% else %}bg-orange-500{% endif %}"></span>
                                        <span class="text-gray-700 line-clamp-2">{{ alert.description }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Charts Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Bug Types Distribution Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Bug Types Distribution</h3>
                    <div class="w-full" style="height: 300px;">
                        <canvas id="bugTypePie"></canvas>
                    </div>
                            </div>
                <!-- Reports by Domain Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Reports by Domain</h3>
                    <div class="w-full" style="height: 300px;">
                        <canvas id="domainPie"></canvas>
                    </div>
                </div>
            </div>
            <!-- Monthly Report Chart -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Monthly Bug Reports - {{ get_current_year_monthly_reported_bar_data.current_year }}</h2>
                            </div>
                <div class="p-6">
                    <div class="w-full" style="height: 350px;">
                        <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
{% endblock body %}
{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Chart.js default configuration
        if (typeof Chart !== 'undefined') {
            Chart.defaults.font.family = "'Inter', 'system-ui', '-apple-system', 'sans-serif'";
            Chart.defaults.color = '#6B7280';
        }

        // Helper function to parse and validate chart data
        function parseChartData(labelsRaw, dataRaw, emptyMessage, errorIcon) {
            if (!labelsRaw || labelsRaw.trim() === '' || labelsRaw === 'null') {
                labelsRaw = '[]';
            }
            if (!dataRaw || dataRaw.trim() === '' || dataRaw === 'null') {
                dataRaw = '[]';
            }

            try {
                const labels = JSON.parse(labelsRaw);
                const data = JSON.parse(dataRaw);

                if (!Array.isArray(labels) || !Array.isArray(data) || labels.length === 0 || data.length === 0) {
                    return { success: false, empty: true, message: emptyMessage, icon: errorIcon };
                }

                if (labels.length !== data.length) {
                    console.warn('Labels and data length mismatch:', labels.length, 'vs', data.length);
                }

                return { success: true, labels, data };
            } catch (error) {
                console.error('JSON Parse Error:', error);
                return { success: false, empty: false, message: 'Error loading chart data', icon: 'fas fa-exclamation-triangle' };
            }
        }

        // Helper function to show empty/error message
        function showChartMessage(element, message, icon) {
            element.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><div class="text-center"><i class="${icon} text-gray-300 text-4xl mb-3"></i><p class="text-gray-500 text-sm">${message}</p></div></div>`;
        }

        // Shared pie chart configuration
        const pieChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        };

        // Color palettes
        const pieColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#95a5a6', '#34495e', '#16a085'];

        // Bug Type Pie Chart
        function initBugTypePie() {
            const ctx = document.getElementById('bugTypePie');
            if (!ctx) return;

            const result = parseChartData(
                '{{ bug_report_type_piechart_data.bug_report_type_labels|safe }}',
                '{{ bug_report_type_piechart_data.bug_report_type_data|safe }}',
                'No bug type data available',
                'fas fa-chart-pie'
            );

            if (!result.success) {
                showChartMessage(ctx.parentElement, result.message, result.icon);
                return;
            }

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: result.labels,
                    datasets: [{
                        data: result.data,
                        backgroundColor: pieColors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: pieChartOptions
            });
        }

        // Domain Pie Chart
        function initDomainPie() {
            const ctx = document.getElementById('domainPie');
            if (!ctx) return;

            const result = parseChartData(
                '{{ reports_on_domain_piechart_data.bug_report_on_domains_labels|safe }}',
                '{{ reports_on_domain_piechart_data.bug_report_on_domains_data|safe }}',
                'No domain data available',
                'fas fa-globe'
            );

            if (!result.success) {
                showChartMessage(ctx.parentElement, result.message, result.icon);
                return;
            }

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: result.labels,
                    datasets: [{
                        data: result.data,
                        backgroundColor: pieColors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: pieChartOptions
            });
        }

        // Monthly Bar Chart
        function initMonthlyChart() {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;

            const result = parseChartData(
                '{{ get_current_year_monthly_reported_bar_data.bug_monthly_report_labels|safe }}',
                '{{ get_current_year_monthly_reported_bar_data.bug_monthly_report_data|safe }}',
                'No monthly data available',
                'fas fa-chart-bar'
            );

            if (!result.success) {
                showChartMessage(ctx.parentElement, result.message, result.icon);
                return;
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: result.labels,
                    datasets: [{
                        label: 'Bug Reports',
                        data: result.data,
                        backgroundColor: '#e74c3c',
                        borderColor: '#e74c3c',
                        borderWidth: 1,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    return 'Bugs: ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return Number.isInteger(value) ? value : '';
                                }
                            },
                            grid: { color: '#f3f4f6' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Initialize all charts
        function initializeAllCharts() {
            if (typeof Chart === 'undefined') {
                setTimeout(initializeAllCharts, 100);
                return;
            }

            try {
                initBugTypePie();
                initDomainPie();
                initMonthlyChart();
            } catch (error) {
                console.error('Error during chart initialization:', error);
            }
        }

        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(initializeAllCharts, 200);
            });
        } else {
            setTimeout(initializeAllCharts, 200);
        }
    </script>
{% endblock scripts %}
