{% extends "base.html" %}
{% load humanize %}
{% block title %}
    {{ room.name }}
{% endblock title %}
{% block content %}
    {% include "includes/sidenav.html" %}
    <div class="max-w-4xl mx-auto py-8 px-4">
        <!-- Breadcrumbs -->
        {% include "includes/breadcrumbs.html" %}
        <div class="flex items-center justify-between mt-4">
            <h1 class="text-3xl font-bold text-gray-900">{{ room.name }}</h1>
            <div class="flex items-center gap-2">
                <div id="connection-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
                <span id="connection-text" class="text-sm text-gray-600">Connecting...</span>
            </div>
        </div>
        <div id="log-history"
             class="mt-4 p-3 bg-gray-100 rounded-lg h-96 overflow-y-auto scroll-smooth">
            <div id="messages-container" class="space-y-1.5">
                {% for message in room_messages reversed %}
                    <div class="py-1 px-2 bg-white rounded-lg shadow-sm relative group message-item"
                         data-message-id="{{ message.id }}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="text-sm font-medium">{{ message.username }}</p>
                                <p class="text-sm text-gray-700">{{ message.content }}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs text-gray-500">{{ message.timestamp|naturaltime }}</span>
                                    <div class="reactions-container flex items-center gap-1">
                                        {% if message.reactions %}
                                            <script>
                                                document.addEventListener('DOMContentLoaded', function() {
                                                    updateReactions('{{ message.id }}', JSON.parse('{{ message.reactions|escapejs }}'));
                                                });
                                            </script>
                                        {% endif %}
                                    </div>
                                    <button class="add-reaction-btn text-gray-400 hover:text-gray-600 text-sm transition-colors duration-200">
                                        <span class="emoji-button">üòÄ</span>
                                    </button>
                                </div>
                            </div>
                            {% if request.user.is_authenticated and message.user == request.user %}
                                <button class="delete-message-btn opacity-0 group-hover:opacity-100 transition-opacity duration-200 text-red-500 hover:text-red-700">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         class="h-4 w-4"
                                         fill="none"
                                         viewBox="0 0 24 24"
                                         stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        <!-- Emoji Picker Modal -->
        <div id="emoji-picker"
             class="hidden fixed z-50 p-4 bg-white rounded-lg shadow-xl border border-gray-200 transform transition-transform duration-200 ease-in-out max-w-[280px] sm:max-w-none">
            <div class="grid grid-cols-4 sm:grid-cols-8 gap-2">
                <button class="emoji-option p-2 hover:bg-gray-100 rounded text-xl"
                        data-emoji="üëç">üëç</button>
                <button class="emoji-option p-2 hover:bg-gray-100 rounded text-xl"
                        data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
                <button class="emoji-option p-2 hover:bg-gray-100 rounded text-xl"
                        data-emoji="üòä">üòä</button>
                <button class="emoji-option p-2 hover:bg-gray-100 rounded text-xl"
                        data-emoji="üòÇ">üòÇ</button>
                <button class="emoji-option p-2 hover:bg-gray-100 rounded text-xl"
                        data-emoji="üéâ">üéâ</button>
                <button class="emoji-option p-2 hover:bg-gray-100 rounded text-xl"
                        data-emoji="üöÄ">üöÄ</button>
                <button class="emoji-option p-2 hover:bg-gray-100 rounded text-xl"
                        data-emoji="üëè">üëè</button>
                <button class="emoji-option p-2 hover:bg-gray-100 rounded text-xl"
                        data-emoji="üî•">üî•</button>
            </div>
        </div>
        <form id="chat-form" class="mt-4 flex gap-2" onsubmit="return false;">
            <input type="text"
                   id="message-input"
                   class="flex-1 rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500"
                   placeholder="Type your message..."
                   required>
            <button type="submit"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                Send
            </button>
        </form>
    </div>
{% endblock content %}
{% block extra_js %}
    <script>
// WebSocket connection management
let chatSocket = null;
let isConnecting = false;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 2000;
let activeEmojiButton = null;

const connectionStatus = document.getElementById('connection-status');
const connectionText = document.getElementById('connection-text');
const messageInput = document.getElementById('message-input');
const chatForm = document.getElementById('chat-form');
const messagesContainer = document.getElementById('messages-container');
const logHistory = document.getElementById('log-history');
const emojiPicker = document.getElementById('emoji-picker');

function updateConnectionStatus(connected) {
    if (connected) {
        connectionStatus.className = 'w-3 h-3 rounded-full bg-green-500';
        connectionText.textContent = 'Connected';
        connectionText.className = 'text-sm text-green-600';
        messageInput.disabled = false;
    } else {
        connectionStatus.className = 'w-3 h-3 rounded-full bg-red-500';
        connectionText.textContent = 'Disconnected';
        connectionText.className = 'text-sm text-red-600';
        messageInput.disabled = true;
    }
}

function showEmojiPicker(button, messageId) {
    const buttonRect = button.getBoundingClientRect();
    const picker = document.getElementById('emoji-picker');
    const isMobile = window.innerWidth < 640; // sm breakpoint

    picker.style.position = 'fixed';
    
    // Calculate available space
    const spaceBelow = window.innerHeight - buttonRect.bottom;
    const spaceAbove = buttonRect.top;
    const pickerHeight = 200; // Approximate height of picker
    
    // Position horizontally
    if (isMobile) {
        // Center horizontally on mobile
        picker.style.left = '50%';
        picker.style.transform = 'translateX(-50%)';
    } else {
        // Position near the button on desktop
        const leftPosition = Math.min(
            buttonRect.left,
            window.innerWidth - picker.offsetWidth - 10
        );
        picker.style.left = `${leftPosition}px`;
        picker.style.transform = 'none';
    }
    
    // Position vertically
    if (spaceBelow >= pickerHeight || spaceBelow >= spaceAbove) {
        // Position below the button
        picker.style.top = `${buttonRect.bottom + 5}px`;
        picker.style.bottom = 'auto';
    } else {
        // Position above the button
        picker.style.bottom = `${window.innerHeight - buttonRect.top + 5}px`;
        picker.style.top = 'auto';
    }
    
    // Show the picker with animation
    picker.classList.remove('hidden');
    picker.classList.add('opacity-0');
    requestAnimationFrame(() => {
        picker.classList.add('opacity-100');
        picker.classList.remove('opacity-0');
    });
    
    activeEmojiButton = { button, messageId };

    // Close emoji picker when clicking outside
    document.addEventListener('click', closeEmojiPickerOnClickOutside);
}

function closeEmojiPicker() {
    const picker = document.getElementById('emoji-picker');
    picker.classList.add('opacity-0');
    
    // Wait for animation to complete before hiding
    setTimeout(() => {
        picker.classList.add('hidden');
        picker.classList.remove('opacity-0');
    }, 200);
    
    activeEmojiButton = null;
    document.removeEventListener('click', closeEmojiPickerOnClickOutside);
}

function closeEmojiPickerOnClickOutside(event) {
    if (!emojiPicker.contains(event.target) && !event.target.closest('.add-reaction-btn')) {
        closeEmojiPicker();
    }
}

function addReaction(messageId, emoji) {
    if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) return;
    
    chatSocket.send(JSON.stringify({
        'type': 'add_reaction',
        'message_id': messageId,
        'emoji': emoji,
        'room_id': '{{ room.id }}'
    }));
    
    closeEmojiPicker();
}

function updateReactions(messageId, reactions) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!messageElement) return;

    const reactionsContainer = messageElement.querySelector('.reactions-container');
    reactionsContainer.innerHTML = '';

    Object.entries(reactions).forEach(([emoji, users]) => {
        const reactionButton = document.createElement('button');
        reactionButton.className = 'inline-flex items-center px-2 py-1 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors duration-200';
        reactionButton.innerHTML = `
            <span class="mr-1">${emoji}</span>
            <span class="text-xs text-gray-600">${users.length}</span>
        `;
        reactionButton.onclick = () => addReaction(messageId, emoji);
        reactionsContainer.appendChild(reactionButton);
    });
}

function appendMessage(data) {
    if (!messagesContainer) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = 'py-1 px-2 bg-white rounded-lg shadow-sm relative group message-item';
    messageDiv.dataset.messageId = data.message_id;
    
    const isCurrentUser = data.username === '{{ request.user.username }}';
    
    messageDiv.innerHTML = `
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <p class="text-sm font-medium">${escapeHtml(data.username)}</p>
                <p class="text-sm text-gray-700">${escapeHtml(data.message)}</p>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-gray-500">just now</span>
                    <div class="reactions-container flex items-center gap-1"></div>
                    <button class="add-reaction-btn text-gray-400 hover:text-gray-600 text-sm transition-colors duration-200">
                        <span class="emoji-button">üòÄ</span>
                    </button>
                </div>
            </div>
            ${isCurrentUser ? `
                <button class="delete-message-btn opacity-0 group-hover:opacity-100 transition-opacity duration-200 text-red-500 hover:text-red-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            ` : ''}
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    logHistory.scrollTop = logHistory.scrollHeight;
    
    // Add event listeners
    if (isCurrentUser) {
        const deleteBtn = messageDiv.querySelector('.delete-message-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', () => deleteMessage(data.message_id));
        }
    }

    const addReactionBtn = messageDiv.querySelector('.add-reaction-btn');
    if (addReactionBtn) {
        addReactionBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showEmojiPicker(addReactionBtn, data.message_id);
        });
    }

    // Update reactions if any exist
    if (data.reactions) {
        updateReactions(data.message_id, data.reactions);
    }
}

function handleWebSocketMessage(event) {
    try {
        const data = JSON.parse(event.data);
        
        switch (data.type) {
            case 'chat_message':
                appendMessage(data);
                break;
            case 'delete_message':
                handleDeleteMessage(data);
                break;
            case 'connection_status':
                updateConnectionStatus(data.status === 'connected');
                break;
            case 'reaction_update':
                updateReactions(data.message_id, data.reactions);
                break;
            case 'error':
                break;
        }
    } catch (error) {
        // Error handling
    }
}

function connectWebSocket() {
    if (chatSocket && (chatSocket.readyState === WebSocket.OPEN || chatSocket.readyState === WebSocket.CONNECTING)) {
        return;
    }

    if (isConnecting) {
        return;
    }

    isConnecting = true;
    updateConnectionStatus(false);
    
    try {
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        chatSocket = new WebSocket(protocol + window.location.host + '/ws/discussion-rooms/chat/{{ room.id }}/');
        
        chatSocket.onopen = function() {
            isConnecting = false;
            reconnectAttempts = 0;
            updateConnectionStatus(true);
        };

        chatSocket.onclose = function(e) {
            isConnecting = false;
            updateConnectionStatus(false);
            
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(connectWebSocket, reconnectDelay);
            }
        };

        chatSocket.onerror = function(error) {
            isConnecting = false;
            updateConnectionStatus(false);
        };

        chatSocket.onmessage = handleWebSocketMessage;
    } catch (error) {
        isConnecting = false;
        updateConnectionStatus(false);
    }
}

function handleDeleteMessage(data) {
    const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
    if (messageElement) {
        messageElement.remove();
    }
}

function deleteMessage(messageId) {
    if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
        return;
    }

    chatSocket.send(JSON.stringify({
        'type': 'delete_message',
        'message_id': messageId,
        'room_id': '{{ room.id }}'
    }));
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g , "&lt;") .replace( />/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Initialize WebSocket connection and other event listeners
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
    
    // Set up form handler
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!messageInput) return;
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
                connectWebSocket();
                return;
            }
            
            try {
                chatSocket.send(JSON.stringify({
                    'type': 'chat_message',
                    'message': message,
                    'room_id': '{{ room.id }}'
                }));
                messageInput.value = '';
            } catch (error) {
                // Error handling
            }
        });
    }
    
    // Set up emoji option handlers
    document.querySelectorAll('.emoji-option').forEach(option => {
        option.addEventListener('click', (e) => {
            e.stopPropagation();
            if (activeEmojiButton) {
                addReaction(activeEmojiButton.messageId, option.dataset.emoji);
            }
        });
    });

    // Set up reaction buttons for existing messages
    document.querySelectorAll('.add-reaction-btn').forEach(btn => {
        const messageItem = btn.closest('[data-message-id]');
        if (messageItem) {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showEmojiPicker(btn, messageItem.dataset.messageId);
            });
        }
    });
    
    // Set up delete message handlers
    document.querySelectorAll('.delete-message-btn').forEach(btn => {
        const messageItem = btn.closest('[data-message-id]');
        if (messageItem) {
            btn.addEventListener('click', () => deleteMessage(messageItem.dataset.messageId));
        }
    });
});

// Clean up WebSocket connection when leaving the page
window.addEventListener('beforeunload', function() {
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.close();
    }
});

// Add to your existing styles at the top of the file
const styles = document.createElement('style');
styles.textContent = `
    #emoji-picker {
        transition: opacity 0.2s ease-in-out;
    }
    #emoji-picker.opacity-0 {
        opacity: 0;
    }
    #emoji-picker.opacity-100 {
        opacity: 1;
    }
`;
document.head.appendChild(styles);
    </script>
{% endblock extra_js %}
