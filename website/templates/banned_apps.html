{% extends "base.html" %}
{% load static %}
{% block title %}
    Banned Apps
{% endblock title %}
{% block content %}
    {% include "includes/sidenav.html" %}
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8 text-center">Search Banned Apps by Country</h1>
        <!-- Tab Navigation -->
        <div class="max-w-xl mx-auto mb-6">
            <div class="flex border-b border-gray-200">
                <button id="listViewBtn"
                        class="py-2 px-4 font-medium text-red-600 border-b-2 border-red-600">List View</button>
                <button id="mapViewBtn"
                        class="py-2 px-4 font-medium text-gray-500 hover:text-red-600">Map View</button>
            </div>
        </div>
        <!-- Search Bar -->
        <div class="max-w-xl mx-auto mb-8">
            <input type="text"
                   id="countrySearch"
                   placeholder="Enter country name..."
                   class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
        </div>
        <!-- List View -->
        <div id="listView">
            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">Banned Apps Results</h2>
                <div id="appsGrid"
                     class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Results will be inserted here -->
                </div>
            </div>
            <!-- No Results Message -->
            <div id="noResults" class="hidden text-center py-8">
                <p class="text-gray-600">No banned apps found for this country.</p>
            </div>
        </div>
        <!-- Map View -->
        <div id="mapView" class="hidden">
            <div id="map" class="h-96 rounded-lg shadow-md"></div>
            <div id="countryInfo"
                 class="mt-4 p-4 bg-white rounded-lg shadow-md hidden">
                <h3 id="countryName" class="text-xl font-semibold mb-2"></h3>
                <p id="bannedAppsCount" class="text-sm text-red-600 mb-2"></p>
                <div id="bannedAppsList" class="mt-4"></div>
            </div>
        </div>
    </div>
    <!-- Include Leaflet CSS and JS -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        // Initialize variables
        let map;
        let countriesLayer;
        let markersLayer;
        let allCountriesData = {};
        let geoJSONLoaded = false;
        
        // Initialize tabs
        document.getElementById('listViewBtn').addEventListener('click', function() {
            document.getElementById('listView').classList.remove('hidden');
            document.getElementById('mapView').classList.add('hidden');
            this.classList.add('text-red-600', 'border-b-2', 'border-red-600');
            this.classList.remove('text-gray-500');
            document.getElementById('mapViewBtn').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
            document.getElementById('mapViewBtn').classList.add('text-gray-500');
        });
        
        document.getElementById('mapViewBtn').addEventListener('click', function() {
            document.getElementById('mapView').classList.remove('hidden');
            document.getElementById('listView').classList.add('hidden');
            this.classList.add('text-red-600', 'border-b-2', 'border-red-600');
            this.classList.remove('text-gray-500');
            document.getElementById('listViewBtn').classList.remove('text-red-600', 'border-b-2', 'border-red-600');
            document.getElementById('listViewBtn').classList.add('text-gray-500');
            
            // Initialize map if it hasn't been initialized yet
            if (!map) {
                initMap();
            }
        });
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Create layer for markers
            markersLayer = L.layerGroup().addTo(map);

            // Load countries GeoJSON
            fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
                .then(response => response.json())
                .then(data => {
                    const features = data.features || [];
                    countriesLayer = L.geoJSON(features, {
                        style: {
                            fillColor: "#f3f4f6",
                            weight: 1,
                            color: "#d1d5db",
                            fillOpacity: 0.7
                        },
                        onEachFeature: function (feature, layer) {
                            const countryName = (feature.properties.name || feature.properties.ADMIN || "").toLowerCase();
                            if (!countryName) return;
                            
                            // Store country data for later use
                            allCountriesData[countryName.toLowerCase()] = {
                                layer: layer,
                                center: layer.getBounds().getCenter(),
                                feature: feature
                            };
                            
                            layer.on({
                                mouseover: function () {
                                    layer.setStyle({ weight: 2, color: "#9ca3af" });
                                },
                                mouseout: function () {
                                    countriesLayer.resetStyle(layer);
                                }
                            });
                        }
                    }).addTo(map);
                    geoJSONLoaded = true;
                })
                .catch(err => { console.error("Error loading GeoJSON:", err);
                    geoJSONLoaded = true;
                });
        }
        
        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
        
        // Search function
        document.getElementById('countrySearch').addEventListener('input', debounce(function(e) {
            const country = e.target.value.trim();
            searchApps(country);
        }, 300));
        
        function searchApps(country) {
            if (!geoJSONLoaded) {
                setTimeout(() => searchApps(country), 500);
                return;
            }
            if (!country) {
                hideResults();
                resetMap();
                return;
            }
            
            fetch(`/api/banned_apps/search/?country=${encodeURIComponent(country)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.apps || data.apps.length === 0) {
                        showNoResults();
                        highlightCountry(country, false);
                    } else {
                        showResults(data.apps);
                        placeCountryMarker(country, data.apps);
                        highlightCountry(country, true);
                    }
                })
                .catch(err => console.error('Error:', err));
        }
        
        // Highlight country 
        function highlightCountry(country, hasApps) {
            if (!map || !countriesLayer) return;
            resetMap();
            
            const lower = country.toLowerCase();
            const countryData = allCountriesData[lower];
            if (!countryData) return;
            
            countryData.layer.setStyle({
                fillColor: hasApps ? '#ef4444' : '#a1a1aa',
                weight: 2,
                color: hasApps ? '#b91c1c' : '#71717a',
                fillOpacity: 0.8
            });
            
            map.flyToBounds(countryData.layer.getBounds(), { duration: 1.2 });
        }
        
        // Place marker
        function placeCountryMarker(country, apps) {
            if (!markersLayer) return;
            markersLayer.clearLayers();
            
            const lower = country.toLowerCase();
            const countryData = allCountriesData[lower];
            if (!countryData) return;
            
            const center = countryData.center;
            const count = apps.length;
            const displayCount = count;
            const markerHTML = `
                <div style="position: relative; width: 42px; height: 42px;">
                    <div style="width: 42px; height: 42px; border-radius: 50% 50% 50% 0; background: #dc2626; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: 700; box-shadow: 0 0 10px rgba(0,0,0,0.25); ">
                        <div style="transform: rotate(45deg);">
                            ${displayCount}
                        </div>
                    </div>
                </div>`;
            
            const marker = L.marker(center, {
                icon: L.divIcon({
                    className: "map-pin-marker",
                    html: markerHTML,
                    iconSize: [42, 42],
                    iconAnchor: [21, 42]
                })
            });

            marker.bindTooltip(
                `${count} banned ${count === 1 ? "app" : "apps"}`,
                { permanent: false, direction: "top", offset: [0, -5] }
            );

            // Banned apps in map
            marker.on("click", () => {
                showCountryInfo(country, apps);
            });

            markersLayer.addLayer(marker);
        }

        function showResults(apps) {
            const grid = document.getElementById('appsGrid');
            grid.innerHTML = '';
            
            apps.forEach(app => {
                const card = createAppCard(app);
                grid.appendChild(card);
            });
            
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('noResults').classList.add('hidden');
        }
        
        function createAppCard(app) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow';
            
            div.innerHTML = `
                <h3 class="text-xl font-semibold mb-2 text-red-600">${app.app_name}</h3>
                <p class="text-sm text-gray-600 mb-2">${app.app_type}</p>
                <p class="text-gray-800 mb-4">${app.ban_reason}</p>
                <div class="text-sm text-gray-600">
                    <p>Ban Date: ${new Date(app.ban_date).toLocaleDateString()}</p>
                    ${app.source_url ? `<a href="${app.source_url}" target="_blank" class="text-red-600 hover:underline">Source â†’</a>` : ''}
                </div>
            `;
            
            return div;
        }
                
        function showCountryInfo(country, apps) {
            const countryInfoDiv = document.getElementById('countryInfo');

            const countryData = allCountriesData[country.toLowerCase()];
            const properName = countryData?.feature?.properties?.name || country;
            document.getElementById('countryName').textContent = properName;

            // Update banned apps count
            document.getElementById('bannedAppsCount').textContent = `${apps.length} Banned Apps`;

            // Update banned apps list 
            const appsList = document.getElementById('bannedAppsList');
            
            while (appsList.firstChild) appsList.removeChild(appsList.firstChild);

            apps.forEach(app => {
                const appDiv = document.createElement('div');
                appDiv.className = 'py-2 border-b border-gray-200';

                const name = document.createElement('h4');
                name.className = 'font-semibold text-red-600';
                name.textContent = app.app_name || '';

                const type = document.createElement('p');
                type.className = 'text-sm text-gray-600';
                type.textContent = app.app_type || '';

                const reason = document.createElement('p');
                reason.className = 'text-sm mt-1';
                reason.textContent = app.ban_reason || '';

                const date = document.createElement('p');
                date.className = 'text-xs mt-1';
                try {
                    date.textContent = `Ban Date: ${new Date(app.ban_date).toLocaleDateString()}`;
                } catch (e) {
                    date.textContent = `Ban Date: ${app.ban_date || 'N/A'}`;
                }

                appDiv.appendChild(name);
                appDiv.appendChild(type);
                appDiv.appendChild(reason);
                appDiv.appendChild(date);

                appsList.appendChild(appDiv);
            });

            // Show the country info section
            countryInfoDiv.classList.remove('hidden');
        }

        function showNoResults() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('noResults').classList.remove('hidden');
            document.getElementById('countryInfo').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('countryInfo').classList.add('hidden');
        }

        function resetMap() {
            if (!map || !countriesLayer) return;

            // Reset country styles
            countriesLayer.eachLayer(layer => {
                countriesLayer.resetStyle(layer);
            });

            // Hide country info
            document.getElementById('countryInfo').classList.add('hidden');
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Set default view to List View
            document.getElementById('listViewBtn').click();
        });
        
    </script>
{% endblock %}
