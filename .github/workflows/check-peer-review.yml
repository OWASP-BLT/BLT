name: Check Peer Review

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted, dismissed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  check_peer_review:
    runs-on: ubuntu-latest
    steps:
      - name: Check for Peer Review and Add Label
        id: check_peer_review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO_FULL="${{ github.repository }}"
          REPO_OWNER="${REPO_FULL%/*}"
          REPO_NAME="${REPO_FULL#*/}"

          # 1. Fetch PR details with error handling (Fixes Sentry HIGH bug)
          PR_RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER")
          HTTP_STATUS=$(echo "$PR_RESPONSE" | tail -n 1)
          PR_BODY=$(echo "$PR_RESPONSE" | head -n -1)

          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Error: Failed to fetch PR details (Status: $HTTP_STATUS)"
            exit 1
          fi

          PR_AUTHOR=$(echo "$PR_BODY" | jq -r '.user.login')

          # 2. Skip for Dependabot
          if [[ "$PR_AUTHOR" == "dependabot[bot]" || "$PR_AUTHOR" == "dependabot" ]]; then
            echo "has_peer_review=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 3. Get and filter reviews
          REVIEWS_RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER/reviews")
          HTTP_STATUS_REVIEWS=$(echo "$REVIEWS_RESPONSE" | tail -n 1)
          REVIEWS_BODY=$(echo "$REVIEWS_RESPONSE" | head -n -1)
          if [ "$HTTP_STATUS_REVIEWS" -ne 200 ]; then
            echo "Error: Failed to fetch PR reviews (Status: $HTTP_STATUS_REVIEWS)"
            exit 1
          fi

          VALID_REVIEWERS=$(echo "$REVIEWS_BODY" | jq -r --arg author "$PR_AUTHOR" '
            .[] | select(.state == "APPROVED") | 
            select(.user.login != $author) | 
            select(.user.login != "DonnieBLT") | 
            select(.user.login != "coderabbitai[bot]") | 
            select(.user.login | ascii_downcase | contains("copilot") | not) | 
            .user.login' | sort -u)

          if [ -z "$VALID_REVIEWERS" ]; then
            echo "has_peer_review=false" >> "$GITHUB_OUTPUT"
            
            # 4. Anti-Spam: Fingerprint check (Fixes Sentry HIGH bug)
            COMMENTS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/comments")
            
             EXISTING_COMMENT=$(echo "$COMMENTS_RESPONSE" | jq -r '.[] | select(.body | contains("<!-- peer-review-check -->")) | .id' | head -n 1)

            if [ -z "$EXISTING_COMMENT" ]; then
              COMMENT_BODY="<!-- peer-review-check -->
            ðŸ‘‹ Hi @${PR_AUTHOR}! This PR needs a peer review from a maintainer to proceed."
              jq -n --arg body "$COMMENT_BODY" '{body: $body}' > /tmp/comment.json
              curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
                -d @/tmp/comment.json \
                "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/comments"
            fi
          else
            echo "has_peer_review=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Add Peer Review Status Label
        if: always()
        uses: actions/github-script@v8 
        with:
           github-token: ${{ secrets.GITHUB_TOKEN }}
           script: |
            const hasReview = '${{ steps.check_peer_review.outputs.has_peer_review }} === 'true';
            const newLabel = hasReview ? 'has-peer-review' : 'needs-peer-review';
            const oldLabel = hasReview ? 'needs-peer-review' : 'has-peer-review';
            const color = hasReview ? '0e8a16' : 'fbca04';

            // 1. Ensure the new label exists in the repository
            async function ensureLabelExists(name, color) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: name
                });
              } catch (e) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: name,
                  color: color
                });
              }
            }

            await ensureLabelExists(newLabel, color);

            //2. Remove the old status label if it exists
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: oldLabel
              });
            } catch (e) {}

            //3. Add the new status label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [newLabel]
            });            });