name: Dismiss Change Requests on New Commit

# When new commits are pushed to a PR with "changes requested" reviews,
# automatically dismiss those reviews since the author is addressing feedback.
# Uses pull_request_target so it runs with base repo permissions for forked PRs.
# SECURITY: We do NOT check out or execute PR code. We only use the GitHub API.
on:
  pull_request_target:
    types:
      - synchronize

permissions:
  contents: read
  pull-requests: write

# Prevent multiple workflow runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  dismiss_change_requests:
    runs-on: ubuntu-latest
    steps:
      - name: Dismiss Change Requested Reviews
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            core.info(`Processing PR #${pull_number}`);
            core.info('New commits pushed, checking for change requests');

            try {
              // Get all reviews for the PR (with pagination)
              const reviews = await github.paginate(
                github.rest.pulls.listReviews,
                {
                  owner,
                  repo,
                  pull_number,
                  per_page: 100,
                }
              );

              const totalReviews = reviews.length;
              core.info(`Found ${totalReviews} total reviews`);

              // Build a map of the most recent review per reviewer
              const latestReviewByUser = new Map();
              for (const review of reviews) {
                const login = review.user && review.user.login;
                if (!login) continue;

                const existing = latestReviewByUser.get(login);
                if (
                  !existing ||
                  (review.submitted_at &&
                    new Date(review.submitted_at) >
                      new Date(existing.submitted_at || 0))
                ) {
                  latestReviewByUser.set(login, review);
                }
              }

              // From the latest reviews, keep only "CHANGES_REQUESTED"
              const changeRequestedReviews = Array.from(
                latestReviewByUser.values(),
              ).filter(review => review.state === 'CHANGES_REQUESTED');
              if (changeRequestedReviews.length === 0) {
                core.info('No "changes requested" reviews to dismiss');
                return;
              }

              const count = changeRequestedReviews.length;
              core.info(`Found ${count} "changes requested" review(s)`);

              // Dismiss each "changes requested" review
              let dismissedCount = 0;
              for (const review of changeRequestedReviews) {
                try {
                  const dismissMsg = 'ðŸ”„ New commits have been pushed. ' +
                    'Dismissing this review as the author is ' +
                    'addressing feedback. Please re-review when ready.';

                  await github.rest.pulls.dismissReview({
                    owner,
                    repo,
                    pull_number,
                    review_id: review.id,
                    message: dismissMsg,
                  });

                  const reviewer = review.user && review.user.login;
                  const reviewId = review.id;
                  const msg = `âœ… Dismissed review #${reviewId}`;
                  if (reviewer) {
                    core.info(`${msg} from @${reviewer}`);
                  } else {
                    core.info(`${msg}`);
                  }
                  dismissedCount++;
                } catch (err) {
                  const msg = `Failed to dismiss review #${review.id}`;
                  core.warning(`${msg}: ${err.message}`);
                }
              }

              if (dismissedCount > 0) {
                const msg = `Successfully dismissed ${dismissedCount}` +
                  ` "changes requested" review(s)`;
                core.info(`âœ… ${msg}`);

                // Wait briefly to ensure GitHub processes the dismissals
                // before other workflows (like add-changes-requested-label)
                // check the review states
                core.info('Waiting 2 seconds for GitHub to process...');
                await new Promise(resolve => setTimeout(resolve, 2000));
              } else {
                core.warning('Failed to dismiss any reviews');
              }
            } catch (error) {
              const msg = `Error processing PR #${pull_number}`;
              core.error(`${msg}: ${error.message}`);
              throw error;
            }
