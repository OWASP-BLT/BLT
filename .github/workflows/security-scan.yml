name: Security Scanning

# Security scanning workflow for dependency vulnerabilities, code security issues,
# and secrets detection. This workflow complements CodeQL with additional security tools.

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    # Run weekly on Sundays at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

concurrency:
  cancel-in-progress: true
  group: security-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.2'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Install project dependencies
        run: |
          pip install poetry
          poetry export -f requirements.txt --output requirements.txt --without-hashes

      - name: Run pip-audit
        id: pip-audit
        continue-on-error: true
        run: |
          set +e
          pip-audit -r requirements.txt --format json --output pip-audit-results.json 2>&1 | tee pip-audit-output.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload pip-audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-results
          path: |
            pip-audit-results.json
            pip-audit-output.txt
          retention-days: 30

      - name: Check for critical vulnerabilities
        if: steps.pip-audit.outputs.exit_code != '0'
        run: |
          echo "::warning::Dependency vulnerabilities found. Please review pip-audit-results.json"
          # Don't fail the build for now, just warn
          # exit 1

  bandit-scan:
    name: Python Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.2'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit security scan
        id: bandit
        continue-on-error: true
        run: |
          set +e
          bandit -r . -x ./node_modules,./venv,./.venv,./tests,./website/tests -f json -o bandit-results.json 2>&1 | tee bandit-output.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload Bandit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-results
          path: |
            bandit-results.json
            bandit-output.txt
          retention-days: 30

      - name: Upload Bandit SARIF
        if: always()
        run: |
          pip install bandit-sarif-formatter
          bandit -r . -x ./node_modules,./venv,./.venv,./tests,./website/tests -f sarif -o bandit-results.sarif || true

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit-results.sarif
          category: bandit
        continue-on-error: true

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets
        id: secrets
        continue-on-error: true
        run: |
          set +e
          detect-secrets scan --all-files --exclude-files '\.git/.*' --exclude-files 'node_modules/.*' --exclude-files '\.env\.example' > secrets-results.json 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Check for secrets
        run: |
          if [ -f secrets-results.json ]; then
            SECRETS_COUNT=$(cat secrets-results.json | python -c "import sys, json; data=json.load(sys.stdin); print(sum(len(v) for v in data.get('results', {}).values()))" 2>/dev/null || echo "0")
            if [ "$SECRETS_COUNT" != "0" ]; then
              echo "::warning::Potential secrets detected: $SECRETS_COUNT findings. Please review secrets-results.json"
            else
              echo "No secrets detected"
            fi
          fi

      - name: Upload secrets scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-scan-results
          path: secrets-results.json
          retention-days: 30

  security-summary:
    name: Security Summary
    needs: [dependency-scan, bandit-scan, secrets-scan]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Add security label
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.issue.number;

            if (!pull_number) {
              core.warning('No pull request number found. Skipping label.');
              return;
            }

            // Check job results
            const depScan = '${{ needs.dependency-scan.result }}';
            const banditScan = '${{ needs.bandit-scan.result }}';
            const secretsScan = '${{ needs.secrets-scan.result }}';

            const allPassed = depScan === 'success' && banditScan === 'success' && secretsScan === 'success';
            const newLabel = allPassed ? 'security: passed' : 'security: review needed';
            const labelColor = allPassed ? '0e8a16' : 'fbca04';
            const description = allPassed ? 'Security scans passed' : 'Security scans need review';

            // Get current labels
            const { data: current } = await github.rest.issues.listLabelsOnIssue({
              owner,
              repo,
              issue_number: pull_number,
              per_page: 100
            });
            const currentNames = new Set(current.map(l => l.name));

            // Remove existing security labels
            const securityRegex = /^security:/i;
            for (const name of currentNames) {
              if (securityRegex.test(name) && name !== newLabel) {
                try {
                  await github.rest.issues.removeLabel({
                    owner,
                    repo,
                    issue_number: pull_number,
                    name
                  });
                } catch (err) {
                  core.warning(`Failed to remove label ${name}: ${err.message}`);
                }
              }
            }

            // Create label if it doesn't exist
            try {
              await github.rest.issues.getLabel({ owner, repo, name: newLabel });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: newLabel,
                  color: labelColor,
                  description: description
                });
              }
            }

            // Add label
            if (!currentNames.has(newLabel)) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pull_number,
                labels: [newLabel]
              });
              core.info(`Applied label ${newLabel} to PR #${pull_number}`);
            }
