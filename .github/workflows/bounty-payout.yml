name: Bounty Payout

on:
  pull_request:
    types: [closed]

jobs:
  process-bounty:
    permissions:
      contents: read
      issues: write
      pull-requests: write
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Check for linked issues with bounties
        id: check-issues
        uses: actions/github-script@v6.1.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const core = require('@actions/core');
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';

            // Look for issue closing keywords in PR body
            const issueRefs = prBody.match(/(close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+#(\d+)/gi);

            if (!issueRefs) {
              console.log('No issue references found in PR');
              return;
            }

            // Extract issue numbers
            const issueNumbers = issueRefs.map(ref => {
              const match = ref.match(/#(\d+)/);
              return match ? match[1] : null;
            }).filter(Boolean);

            if (issueNumbers.length === 0) {
              console.log('No valid issue numbers found');
              return;
            }

            const parseBountyLabel = (labelName) => {
              if (!labelName || !labelName.includes('$')) {
                return null;
              }

              const trimmed = labelName.trim();
              const timedMatch = trimmed.match(/^\$(\d+(?:\.\d{2})?)\s+(\d+)$/);
              if (timedMatch) {
                return {
                  amount: timedMatch[1],
                  durationHours: parseInt(timedMatch[2], 10),
                  labelName: labelName
                };
              }

              const bountyMatch = trimmed.match(/\$(\d+(?:\.\d{2})?)/);
              if (bountyMatch) {
                return {
                  amount: bountyMatch[1],
                  durationHours: null,
                  labelName: labelName
                };
              }

              return null;
            };

            // Check each issue for bounty labels
            let bountyIssue = null;
            let bountyLabelDetails = null;
            for (const issueNumber of issueNumbers) {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber)
              });

              // Check for dollar sign labels
              for (const label of issue.data.labels) {
                const parsed = parseBountyLabel(label.name);
                if (parsed) {
                  bountyIssue = issue.data;
                  bountyLabelDetails = parsed;
                  break;
                }
              }

              if (bountyIssue) {
                break;
              }
            }

            if (!bountyIssue) {
              console.log('No issues with bounty labels found');
              return;
            }

            if (!bountyLabelDetails) {
              console.log('Bounty label details missing');
              return;
            }

            const prCreatedAt = new Date(pr.created_at);

            if (bountyLabelDetails.durationHours) {
              const events = await github.paginate(github.rest.issues.listEvents, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: bountyIssue.number,
                per_page: 100
              });

              const labelEvent = events
                .filter(event => event.event === 'labeled' && event.label && event.label.name === bountyLabelDetails.labelName)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

              const labelAttachedAt = labelEvent ? new Date(labelEvent.created_at) : new Date(bountyIssue.created_at);

              if (!labelEvent) {
                console.log('Timed bounty label timestamp not found; falling back to issue creation time.');
              }

              const expiryTime = new Date(labelAttachedAt.getTime() + bountyLabelDetails.durationHours * 60 * 60 * 1000);

              if (prCreatedAt > expiryTime) {
                console.log(`PR was opened after timed bounty expired (${expiryTime.toISOString()}); skipping payout.`);
                return;
              }
            }

            let bountyAmount = bountyLabelDetails.amount;

            // Convert to cents for API (e.g., "25.50" -> 2550, "50" -> 5000)
            if (bountyAmount) {
              bountyAmount = Math.round(parseFloat(bountyAmount) * 100).toString();
            }

            if (!bountyAmount) {
              console.log('Could not extract bounty amount from label');
              return;
            }

            // Human-readable dollar amount for display
            const bountyDisplay = bountyMatch[1];

            core.setOutput('has-bounty', 'true');
            core.setOutput('issue-number', bountyIssue.number.toString());
            core.setOutput('bounty-amount', bountyAmount);
            core.setOutput('bounty-display', bountyDisplay);
            core.setOutput('contributor-username', pr.user.login);

      - name: Send bounty data to BLT
        if: steps.check-issues.outputs['has-bounty'] == 'true'
        continue-on-error: true
        env:
          ISSUE_NUMBER: ${{ steps.check-issues.outputs.issue-number }}
          BOUNTY_AMOUNT: ${{ steps.check-issues.outputs.bounty-amount }}
          CONTRIBUTOR_USERNAME: ${{ steps.check-issues.outputs.contributor-username }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BLT_API_TOKEN: ${{ secrets.BLT_API_TOKEN }}
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://owasp.org' }}
        uses: actions/github-script@v6.1.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = await fetch(`${process.env.API_BASE_URL}/bounty_payout/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-BLT-API-TOKEN': process.env.BLT_API_TOKEN
              },
              body: JSON.stringify({
                issue_number: parseInt(process.env.ISSUE_NUMBER),
                repo: context.repo.repo,
                owner: context.repo.owner,
                bounty_amount: parseInt(process.env.BOUNTY_AMOUNT),
                contributor_username: process.env.CONTRIBUTOR_USERNAME,
                pr_number: parseInt(process.env.PR_NUMBER)
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Bounty payout request failed: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            console.log('Bounty payout request successful:', result);

      - name: Post bounty notification comments
        if: steps.check-issues.outputs['has-bounty'] == 'true'
        uses: actions/github-script@v6.1.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt('${{ steps.check-issues.outputs.issue-number }}');
            const bountyDisplay = '${{ steps.check-issues.outputs.bounty-display }}';
            const prAuthor = '${{ steps.check-issues.outputs.contributor-username }}';
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sponsorsUrl = `https://github.com/sponsors/${prAuthor}`;

            const issueComment = `ðŸŽ‰ This issue had a **$${bountyDisplay}** bounty attached!\n\nThe fix was contributed by @${prAuthor}. If you'd like to support their work, you can visit their profile at https://github.com/${prAuthor} or sponsor them at ${sponsorsUrl} (if GitHub Sponsors is enabled).`;

            const prComment = `ðŸŽ‰ This PR closed a bounty issue worth **$${bountyDisplay}**!\n\nThank you @${prAuthor} for your contribution! Others can support your work at your profile https://github.com/${prAuthor} or sponsor you at ${sponsorsUrl} (if GitHub Sponsors is enabled).`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: issueComment
            });
            console.log(`Posted bounty comment on issue #${issueNumber}`);

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: prComment
            });
            console.log(`Posted bounty comment on PR #${prNumber}`);
