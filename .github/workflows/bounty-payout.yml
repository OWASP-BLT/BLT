name: Bounty Payout

on:
  pull_request:
    types: [closed]

permissions: {}

jobs:
  process-bounty:
    permissions:
      contents: read
      issues: read
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Check for linked issues with bounties
        id: check-issues
        uses: actions/github-script@v6.1.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const core = require('@actions/core');
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';

            // Look for issue closing keywords in PR body
            const issueRefs = prBody.match(/(close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+#(\d+)/gi);

            if (!issueRefs) {
              console.log('No issue references found in PR');
              return;
            }

            // Extract issue numbers
            const issueNumbers = issueRefs.map(ref => {
              const match = ref.match(/#(\d+)/);
              return match ? match[1] : null;
            }).filter(Boolean);

            if (issueNumbers.length === 0) {
              console.log('No valid issue numbers found');
              return;
            }

            const parseBountyLabel = (labelName) => {
              if (!labelName || !labelName.includes('$')) {
                return null;
              }

              const trimmed = labelName.trim();
              const timedMatch = trimmed.match(/^\$(\d+(?:\.\d{2})?)\s+(\d+)$/);
              if (timedMatch) {
                return {
                  amount: timedMatch[1],
                  durationHours: parseInt(timedMatch[2], 10),
                  labelName: labelName
                };
              }

              const bountyMatch = trimmed.match(/\$(\d+(?:\.\d{2})?)/);
              if (bountyMatch) {
                return {
                  amount: bountyMatch[1],
                  durationHours: null,
                  labelName: labelName
                };
              }

              return null;
            };

            // Check each issue for bounty labels
            let bountyIssue = null;
            let bountyLabelDetails = null;
            for (const issueNumber of issueNumbers) {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber)
              });

              // Check for dollar sign labels
              for (const label of issue.data.labels) {
                const parsed = parseBountyLabel(label.name);
                if (parsed) {
                  bountyIssue = issue.data;
                  bountyLabelDetails = parsed;
                  break;
                }
              }

              if (bountyIssue) {
                break;
              }
            }

            if (!bountyIssue) {
              console.log('No issues with bounty labels found');
              return;
            }

            if (!bountyLabelDetails) {
              console.log('Bounty label details missing');
              return;
            }

            const isTimedBounty = Boolean(bountyLabelDetails.durationHours);
            let bountyAmount = bountyLabelDetails.amount;

            // Convert to cents for API (e.g., "25.50" -> 2550, "50" -> 5000)
            if (bountyAmount) {
              bountyAmount = Math.round(parseFloat(bountyAmount) * 100).toString();
            }

            if (!bountyAmount) {
              console.log('Could not extract bounty amount from label');
              return;
            }

            core.setOutput('has-bounty', 'true');
            core.setOutput('issue-number', bountyIssue.number.toString());
            core.setOutput('bounty-amount', bountyAmount);
            core.setOutput('contributor-username', pr.user.login);
            core.setOutput('is-timed-bounty', isTimedBounty ? 'true' : 'false');

      - name: Send bounty data to BLT
        if: steps.check-issues.outputs['has-bounty'] == 'true'
        env:
          ISSUE_NUMBER: ${{ steps.check-issues.outputs.issue-number }}
          BOUNTY_AMOUNT: ${{ steps.check-issues.outputs.bounty-amount }}
          CONTRIBUTOR_USERNAME: ${{ steps.check-issues.outputs.contributor-username }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          IS_TIMED_BOUNTY: ${{ steps.check-issues.outputs.is-timed-bounty }}
          BLT_API_TOKEN: ${{ secrets.BLT_API_TOKEN }}
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://owasp.org' }}
        uses: actions/github-script@v6.1.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = await fetch(`${process.env.API_BASE_URL}/bounty_payout/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-BLT-API-TOKEN': process.env.BLT_API_TOKEN
              },
              body: JSON.stringify({
                issue_number: parseInt(process.env.ISSUE_NUMBER),
                repo: context.repo.repo,
                owner: context.repo.owner,
                bounty_amount: parseInt(process.env.BOUNTY_AMOUNT),
                contributor_username: process.env.CONTRIBUTOR_USERNAME,
                pr_number: parseInt(process.env.PR_NUMBER),
                is_timed_bounty: process.env.IS_TIMED_BOUNTY === 'true'
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Bounty payout request failed: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            console.log('Bounty payout request successful:', result);
