name: Regenerate Django Migrations

# SECURITY NOTE:
# This workflow uses pull_request_target to allow writing back to forked PRs.
# It only runs when explicitly triggered via the 'regenerate-migrations' label
# or manual workflow dispatch. The workflow executes Django's makemigrations
# command which is safe as it only reads models and generates migration files.
# Maintainers should review PRs for malicious model definitions before
# triggering this workflow.

on:
  workflow_dispatch:
  pull_request_target:
    types:
      - labeled

permissions:
  contents: write
  actions: write
  pull-requests: write

jobs:
  regenerate-migrations:
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request_target' &&
       github.event.label.name == 'regenerate-migrations')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: >
            ${{ github.event_name == 'pull_request_target' &&
            github.event.pull_request.head.ref || github.ref_name }}
          repository: >
            ${{ github.event_name == 'pull_request_target' &&
            github.event.pull_request.head.repo.full_name ||
            github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Identify and delete PR migration files
        run: |
          # Fetch the base branch for comparison
          BASE_BRANCH="${{ github.event_name == 'pull_request_target' &&
            github.event.pull_request.base.ref || 'main' }}"
          git fetch origin "$BASE_BRANCH"

          # Get list of migration files that are new or modified in this PR
          echo "Finding migration files changed in this PR..."
          CHANGED_MIGRATIONS=$(git diff --name-only \
            --diff-filter=AM \
            "origin/$BASE_BRANCH"...HEAD | \
            grep -E '(website|comments)/migrations/.*\.py$' | \
            grep -v '__init__.py' || true)

          if [ -z "$CHANGED_MIGRATIONS" ]; then
            echo "No migration files found in this PR"
            echo "MIGRATION_FILES_FOUND=false" >> $GITHUB_ENV
          else
            echo "Migration files found in PR:"
            echo "$CHANGED_MIGRATIONS"
            echo "MIGRATION_FILES_FOUND=true" >> $GITHUB_ENV

            # Delete each migration file found in the PR
            echo "$CHANGED_MIGRATIONS" | while read -r file; do
              if [ -f "$file" ]; then
                echo "Deleting: $file"
                rm "$file"
              fi
            done

            echo ""
            echo "Remaining files in website/migrations:"
            ls -la website/migrations/ || true
            echo ""
            echo "Remaining files in comments/migrations:"
            ls -la comments/migrations/ || true
          fi

      - name: Create .env file for settings
        run: |
          # Create a minimal .env file with required settings
          # Generate a secure random secret key
          SECRET_KEY=$(python -c \
            "import secrets; print(secrets.token_urlsafe(50))")
          cat > .env << EOF
          SECRET_KEY=$SECRET_KEY
          DATABASE_URL=sqlite:///db.sqlite3
          DEBUG=True
          EOF

      - name: Run makemigrations
        run: |
          poetry run python manage.py makemigrations
          echo "Generated new migrations"

          # Show generated migrations
          echo "New migrations in website/migrations:"
          ls -la website/migrations/
          echo "New migrations in comments/migrations:"
          ls -la comments/migrations/

      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "Changes detected after regenerating migrations."
            echo "changes_detected=true" >> $GITHUB_ENV
            git status
          else
            echo "No changes made after regenerating migrations."
            echo "changes_detected=false" >> $GITHUB_ENV
          fi

      - name: Commit and push changes
        if: env.changes_detected == 'true'
        env:
          TRIGGER_TYPE: >
            ${{ github.event_name == 'pull_request_target' &&
            'label' || 'manual dispatch' }}
          PR_NUMBER: ${{ github.event.pull_request.number || 'N/A' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add website/migrations/ comments/migrations/
          git commit -m "Regenerate Django migrations

          Triggered by: $TRIGGER_TYPE
          PR: #$PR_NUMBER"
          git push origin HEAD

      - name: Comment on PR
        if: >
          env.changes_detected == 'true' &&
          github.event_name == 'pull_request_target'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = [
              '## ✅ Migrations Regenerated',
              '',
              'The Django migrations have been successfully regenerated:',
              '- Deleted migration files that were added/modified',
              '  in this PR (except `__init__.py`)',
              '- Ran `python manage.py makemigrations`',
              '  to create fresh migrations',
              '- Committed and pushed the new migration files to this PR',
              '',
              'Please review the changes and ensure all models are',
              'properly migrated.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: Comment on PR if no changes
        if: >
          env.changes_detected == 'false' &&
          github.event_name == 'pull_request_target'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = [
              '## ℹ️ No Migration Changes',
              '',
              'The migration regeneration process completed,',
              'but no changes were detected.',
              'This means the existing migrations are already',
              'up to date with your models.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: Remove label
        if: github.event_name == 'pull_request_target'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'regenerate-migrations'
              });
            } catch (error) {
              // Label might not exist or already removed
              console.log('Could not remove label:', error.message);
            }
