name: Add Files Changed Label

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  pull-requests: write
  contents: read
  issues: write
  repository-projects: write

jobs:
  add_files_changed_label:
    runs-on: ubuntu-latest
    steps:
      - name: Add Files Changed Label
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          BASE_REPO: ${{ github.repository }}
        run: |
          echo "Starting Files Changed Label workflow for PR #$PR_NUMBER in $REPO_OWNER/$REPO_NAME"
          
          # Check if PR is from a fork (external repository)
          if [[ "$PR_HEAD_REPO" != "$BASE_REPO" ]]; then
            echo "This PR is from an external repository: $PR_HEAD_REPO"
            echo "Skipping label operations for external repository PR to avoid permission issues."
            exit 0
          fi
          
          # Get the number of files changed in the PR
          echo "Fetching files changed information..."
          FILES_API_RESPONSE=$(curl -s -X GET \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER/files")
          
          # Check if the API request was successful by verifying it's a valid array
          if ! echo "$FILES_API_RESPONSE" | jq -e 'type == "array"' > /dev/null 2>&1; then
            echo "Error: Could not fetch PR files. The API response was not a valid array."
            echo "This could indicate an authentication issue or the PR may not exist."
            exit 1
          fi
          
          FILES_CHANGED=$(echo "$FILES_API_RESPONSE" | jq '. | length')
          
          echo "Files changed in PR #$PR_NUMBER: $FILES_CHANGED"
          
          # Determine the label based on the exact number of files changed
          LABEL="files-changed: $FILES_CHANGED"
          
          # Set color based on the number of files changed
          if [ "$FILES_CHANGED" -eq 0 ]; then
            LABEL_COLOR="cccccc" # Gray
          elif [ "$FILES_CHANGED" -eq 1 ]; then
            LABEL_COLOR="0e8a16" # Green
          elif [ "$FILES_CHANGED" -ge 2 ] && [ "$FILES_CHANGED" -le 5 ]; then
            LABEL_COLOR="fbca04" # Yellow
          elif [ "$FILES_CHANGED" -ge 6 ] && [ "$FILES_CHANGED" -le 10 ]; then
            LABEL_COLOR="ff9800" # Orange
          else
            LABEL_COLOR="e74c3c" # Red (using the project's preferred red color)
          fi
          
          # Set grammatically correct description
          if [ "$FILES_CHANGED" -eq 1 ]; then
            DESCRIPTION="PR changes 1 file"
          else
            DESCRIPTION="PR changes $FILES_CHANGED files"
          fi
          
          echo "Determined label: $LABEL with color: $LABEL_COLOR"
          
          # Get all labels in the repository to check if our label exists
          echo "Checking if label exists in repository..."
          ALL_LABELS_RESPONSE=$(curl -s -X GET \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/labels")
          
          # Check if the response is an array before parsing
          if echo "$ALL_LABELS_RESPONSE" | jq -e 'type == "array"' > /dev/null 2>&1; then
            ALL_REPO_LABELS=$(echo "$ALL_LABELS_RESPONSE" | jq -r '.[].name')
          else
            ERROR_MSG=$(echo "$ALL_LABELS_RESPONSE" | jq -r '.message // empty' 2>/dev/null || echo "Invalid response")
            ERROR_MSG="${ERROR_MSG:-Invalid response}"
            echo "Error: Failed to fetch repository labels. Error: $ERROR_MSG"
            exit 1
          fi
          
          # Create the label if it doesn't exist
          if ! echo "$ALL_REPO_LABELS" | grep -q "$LABEL"; then
            echo "Label '$LABEL' does not exist. Creating it now..."
            CREATE_LABEL_RESPONSE=$(curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/labels" \
              -d "{\"name\":\"$LABEL\",\"color\":\"$LABEL_COLOR\",\"description\":\"$DESCRIPTION\"}")
            
            # Check if label creation was successful (successful response has "name" field)
            if echo "$CREATE_LABEL_RESPONSE" | jq -e 'has("name")' > /dev/null 2>&1; then
              echo "Label '$LABEL' created successfully."
            else
              ERROR_MSG=$(echo "$CREATE_LABEL_RESPONSE" | jq -r '.message // empty' 2>/dev/null || echo "Invalid response")
              ERROR_MSG="${ERROR_MSG:-Invalid response}"
              echo "Warning: There might be an issue creating the label. Error: $ERROR_MSG"
              
              # Provide more detailed guidance for permission errors
              if [[ "$ERROR_MSG" == *"Resource not accessible by integration"* ]]; then
                echo "This appears to be a permissions issue with creating labels."
                echo "The workflow has been configured with appropriate permissions (pull-requests: write, issues: write)."
                echo "If this error persists, please check the repository settings."
              fi
            fi
          else
            echo "Label '$LABEL' already exists in the repository."
          fi
          
          # First, get all existing labels on the PR
          echo "Getting existing labels on PR #$PR_NUMBER..."
          PR_LABELS_RESPONSE=$(curl -s -X GET \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/labels")
          
          # Check if the response is an array before parsing
          if echo "$PR_LABELS_RESPONSE" | jq -e 'type == "array"' > /dev/null 2>&1; then
            EXISTING_LABELS=$(echo "$PR_LABELS_RESPONSE" | jq -r '.[].name')
          else
            ERROR_MSG=$(echo "$PR_LABELS_RESPONSE" | jq -r '.message // empty' 2>/dev/null || echo "Invalid response")
            ERROR_MSG="${ERROR_MSG:-Invalid response}"
            echo "Error: Failed to fetch PR labels. Error: $ERROR_MSG"
            exit 1
          fi
          
          # Remove any existing files-changed labels
          echo "Checking for existing 'files-changed' labels to remove..."
          FOUND_EXISTING_LABEL=false
          for EXISTING_LABEL in $EXISTING_LABELS; do
            if [[ "$EXISTING_LABEL" == "files-changed:"* ]]; then
              FOUND_EXISTING_LABEL=true
              ENCODED_LABEL=$(echo "$EXISTING_LABEL" | sed 's/ /%20/g')
              echo "Removing existing label: $EXISTING_LABEL (encoded as: $ENCODED_LABEL)"
              
              REMOVE_RESPONSE=$(curl -s -X DELETE \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/labels/$ENCODED_LABEL")
                
              if [[ "$REMOVE_RESPONSE" == "" ]]; then
                echo "Successfully removed label: $EXISTING_LABEL"
              else
                ERROR_MSG=$(echo "$REMOVE_RESPONSE" | jq -r '.message // empty' 2>/dev/null || echo "Invalid response")
                ERROR_MSG="${ERROR_MSG:-Invalid response}"
                echo "Warning: There might be an issue removing the label. Error: $ERROR_MSG"
              fi
            fi
          done
          
          if [ "$FOUND_EXISTING_LABEL" = false ]; then
            echo "No existing 'files-changed' labels found on PR #$PR_NUMBER."
          fi
          
          # Add the new label
          echo "Adding label '$LABEL' to PR #$PR_NUMBER..."
          ADD_LABEL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/labels" \
            -d "{\"labels\":[\"$LABEL\"]}")
          
          # Check if label was added successfully (successful response is an array)
          if echo "$ADD_LABEL_RESPONSE" | jq -e 'type == "array"' > /dev/null 2>&1; then
            echo "Successfully applied label '$LABEL' to PR #$PR_NUMBER"
          else
            ERROR_MSG=$(echo "$ADD_LABEL_RESPONSE" | jq -r '.message // empty' 2>/dev/null || echo "Invalid response")
            ERROR_MSG="${ERROR_MSG:-Invalid response}"
            echo "Error: Failed to add label. Error: $ERROR_MSG"
            
            # Check if it's a permissions issue
            if [[ "$ERROR_MSG" == *"Resource not accessible by integration"* ]]; then
              echo "This appears to be a permissions issue."
              echo "The workflow has been configured with appropriate permissions (pull-requests: write, issues: write)."
              echo "If this error persists, please verify the repository settings allow workflow actions."
            fi
            
            exit 1
          fi