name: Auto-Fix Pre-Commit Issues on Main

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-fix-main:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      - name: Cache pre-commit hooks
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: ${{ runner.os }}-pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pre-commit-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.2'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --no-interaction

      - name: Run pre-commit checks
        id: precommit
        continue-on-error: true
        run: |
          poetry run pre-commit run --all-files

      - name: Check if fixes are needed
        id: check_fixes
        if: steps.precommit.outcome == 'failure'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "fixes_needed=true" >> $GITHUB_OUTPUT
            echo "âœ… Pre-commit made auto-fixes"
          else
            echo "fixes_needed=false" >> $GITHUB_OUTPUT
            echo "âŒ Pre-commit failed but no auto-fixes available"
          fi

      - name: Create fix branch and commit
        if: steps.check_fixes.outputs.fixes_needed == 'true'
        id: create_branch
        run: |
          # Get current branch name
          CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          echo "ðŸ“ Current branch: $CURRENT_BRANCH"
          
          # Create unique branch name
          BRANCH_NAME="fix/pre-commit-main-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "base_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸŒ¿ New branch: $BRANCH_NAME"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and switch to new branch
          git checkout -b $BRANCH_NAME
          
          # Commit changes
          git add .
          git commit -m "ðŸ¤– Auto-fix: Apply pre-commit fixes to main

          This commit automatically applies formatting and linting fixes:
          - Black code formatting
          - isort import sorting
          - ruff linting fixes
          - djLint template formatting
          
          Generated by auto-fix-main-precommit workflow"
          
          # Push branch
          git push origin $BRANCH_NAME
          echo "âœ… Branch pushed successfully"

      - name: Create Pull Request
        if: steps.check_fixes.outputs.fixes_needed == 'true'
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          echo "ðŸ”„ Creating pull request..."
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only ${{ steps.create_branch.outputs.base_branch }}..${{ steps.create_branch.outputs.branch_name }} | head -20)
          if [ $(git diff --name-only ${{ steps.create_branch.outputs.base_branch }}..${{ steps.create_branch.outputs.branch_name }} | wc -l) -gt 20 ]; then
            CHANGED_FILES="${CHANGED_FILES}
          ... and more files"
          fi
          
          # Write PR body to a temporary file to avoid escaping issues
          PR_BODY_FILE=$(mktemp)
          cat > "$PR_BODY_FILE" <<EOF
          ## ðŸ¤– Automated Pre-Commit Fixes

          This PR contains automatic formatting and linting fixes applied to the **\`main\`** branch.

          ### ðŸ”§ Changes Applied:
          - âœ… Black code formatting
          - âœ… isort import sorting  
          - âœ… ruff linting fixes
          - âœ… djLint template formatting

          ### ðŸ“ Commit that triggered this:
          - **SHA**: \`${{ github.sha }}\`
          - **Author**: @${{ github.actor }}
          - **Message**: \`${COMMIT_MESSAGE}\`

          \`\`\`
          $COMMIT_MSG
          \`\`\`

          ### ðŸ“‹ Files Changed:
          \`\`\`
          ${CHANGED_FILES}
          \`\`\`

          ### ðŸ·ï¸ Labels
          Please manually add these labels: \`automated-fix\`, \`pre-commit\`

          ---
          **âš ï¸ Please review these changes before merging.**

          _This PR was automatically created by the auto-fix-main-precommit workflow._
          EOF
          
          # Create PR using the body file
          PR_URL=$(gh pr create \
            --base "${{ steps.create_branch.outputs.base_branch }}" \
            --head "${{ steps.create_branch.outputs.branch_name }}" \
            --title "ðŸ¤– Auto-fix: Apply pre-commit fixes to main" \
            --body-file "$PR_BODY_FILE")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "âœ… PR created successfully: $PR_URL"
          
          # Extract and save PR number
          PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]*$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ PR Number: #$PR_NUMBER"

      - name: Comment on original commit
        if: steps.check_fixes.outputs.fixes_needed == 'true' && steps.create_pr.outputs.pr_url != ''
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            -f body="ðŸ¤– **Auto-fix PR Created**

          Pre-commit checks detected formatting issues that were automatically fixed.

          ðŸ‘‰ **Review the fixes here**: ${{ steps.create_pr.outputs.pr_url }}

          Please review and merge the PR to apply the fixes to the main branch." \
            || echo "âš ï¸ Could not add comment to commit"

      - name: Summary
        if: steps.check_fixes.outputs.fixes_needed == 'true'
        run: |
          echo "## ðŸŽ‰ Auto-fix Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Successfully created PR with auto-fixes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **Details**:" >> $GITHUB_STEP_SUMMARY
          echo "- **Base Branch**: \`${{ steps.create_branch.outputs.base_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Fix Branch**: \`${{ steps.create_branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #${{ steps.create_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR URL**: ${{ steps.create_pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘‰ **Next Steps**: Review and merge the PR to apply fixes" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: steps.precommit.outcome == 'failure' && steps.check_fixes.outputs.fixes_needed == 'false'
        run: |
          echo "## âŒ Pre-commit Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pre-commit checks failed but no auto-fixes could be applied." >> $GITHUB_STEP_SUMMARY
          echo "Manual intervention is required." >> $GITHUB_STEP_SUMMARY
          echo "::error::Pre-commit checks failed but no auto-fixes could be applied. Manual intervention required."
          exit 1